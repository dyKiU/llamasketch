<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LlamaSketch — Live AI Sketch to Image</title>
    <meta
      name="description"
      content="Draw a sketch, get an AI-generated image in real time. Powered by FLUX.2 Klein. Free to try, no account needed."
    />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png" />

    <!-- Open Graph / Social -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="LlamaSketch — Live AI Sketch to Image" />
    <meta
      property="og:description"
      content="Draw a sketch, get an AI-generated image in real time. Powered by FLUX.2 Klein."
    />
    <meta property="og:image" content="/favicon-512.png" />
    <meta property="og:url" content="https://llamasketch.com" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="LlamaSketch — Live AI Sketch to Image" />
    <meta
      name="twitter:description"
      content="Draw a sketch, get an AI-generated image in real time."
    />
    <link rel="stylesheet" href="/static/css/theme.css" />
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* Header */
      header {
        background: var(--header-bg);
        color: #fff;
        padding: 12px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      header h1 {
        font-size: 1.25rem;
        font-weight: 600;
      }
      .header-right {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .theme-toggle {
        background: none;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 6px;
        color: #fff;
        cursor: pointer;
        font-size: 1.1rem;
        padding: 4px 8px;
        line-height: 1;
        transition: border-color 0.15s;
      }
      .theme-toggle:hover {
        border-color: rgba(255, 255, 255, 0.6);
      }
      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
      }
      .status-dot.connected {
        background: #4caf50;
      }
      .status-dot.disconnected {
        background: #f44336;
      }
      .health-indicator {
        display: flex;
        align-items: center;
        font-size: 0.85rem;
        opacity: 0.9;
      }
      .gpu-stats {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.75rem;
        opacity: 0.85;
      }
      .gpu-stats .gpu-label {
        color: rgba(255, 255, 255, 0.6);
      }
      .gpu-stats .gpu-bar {
        width: 60px;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        overflow: hidden;
      }
      .gpu-stats .gpu-bar-fill {
        height: 100%;
        border-radius: 4px;
        transition:
          width 0.5s,
          background 0.5s;
      }
      .gpu-stats .gpu-text {
        min-width: 32px;
        color: #fff;
      }

      /* Usage counter */
      .usage-counter {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.75rem;
        opacity: 0.9;
      }
      .usage-counter .usage-bar {
        width: 48px;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        overflow: hidden;
      }
      .usage-counter .usage-bar-fill {
        height: 100%;
        border-radius: 4px;
        transition:
          width 0.4s,
          background 0.4s;
        background: #4caf50;
      }
      .usage-counter .usage-bar-fill.warn {
        background: #ff9800;
      }
      .usage-counter .usage-bar-fill.critical {
        background: #f44336;
      }
      .usage-counter .usage-text {
        color: rgba(255, 255, 255, 0.85);
        white-space: nowrap;
      }
      .usage-counter .usage-text.warn {
        color: #ff9800;
      }
      .usage-counter .usage-text.critical {
        color: #f44336;
      }

      /* Main layout */
      main {
        display: flex;
        flex: 1;
        gap: 0;
        overflow: hidden;
        align-items: flex-start;
      }
      .panel {
        padding: 24px;
        overflow-y: auto;
        max-height: 100%;
      }
      .panel-left {
        flex: 1;
        border-right: 1px solid var(--border);
        background: var(--panel-bg);
        min-width: 0;
      }
      .panel-right {
        flex: 1;
        background: var(--panel-alt);
        min-width: 0;
        display: flex;
        flex-direction: column;
      }

      /* Section labels */
      .section-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: 8px;
        font-weight: 600;
      }

      /* Mode tabs */
      .mode-tabs {
        display: flex;
        gap: 0;
        margin-bottom: 16px;
        border-bottom: 2px solid var(--border);
      }
      .mode-tab {
        padding: 8px 16px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-muted);
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: all 0.15s;
      }
      .mode-tab:hover {
        color: var(--text);
      }
      .mode-tab.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
        font-weight: 600;
      }
      .mode-content {
        display: none;
      }
      .mode-content.active {
        display: block;
      }

      /* Image preview areas */
      .preview-container {
        width: 100%;
        max-width: 400px;
        aspect-ratio: 1;
        background: var(--preview-bg);
        border: 2px dashed var(--border);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        margin-bottom: 16px;
        position: relative;
      }
      .preview-container img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }
      .preview-container.has-image {
        border-style: solid;
        border-color: var(--border);
      }
      .preview-placeholder {
        color: var(--text-muted);
        font-size: 0.9rem;
      }

      /* Sketch preset buttons */
      .sketch-presets {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 16px;
      }
      .sketch-presets button {
        padding: 8px 16px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--input-bg);
        color: var(--text);
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.15s;
      }
      .sketch-presets button:hover {
        border-color: var(--text-muted);
        background: var(--preview-bg);
      }
      .sketch-presets button.active {
        border-color: var(--accent);
        background: var(--accent);
        color: #fff;
      }

      /* Upload area */
      .upload-area {
        margin-bottom: 16px;
      }
      .upload-btn {
        position: relative;
        overflow: hidden;
        padding: 8px 16px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--input-bg);
        color: var(--text);
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.15s;
      }
      .upload-btn:hover {
        border-color: var(--text-muted);
        background: var(--preview-bg);
      }
      .upload-btn input[type="file"] {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
      }

      /* Form controls */
      .form-group {
        margin-bottom: 16px;
      }
      .form-group label {
        display: block;
        font-size: 0.85rem;
        font-weight: 500;
        margin-bottom: 4px;
        color: var(--text);
      }
      .form-group input[type="text"],
      .form-group textarea {
        width: 100%;
        max-width: 400px;
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 0.9rem;
        font-family: inherit;
        background: var(--input-bg);
        color: var(--text);
      }
      .form-group textarea {
        resize: vertical;
        min-height: 60px;
      }
      .range-row {
        display: flex;
        align-items: center;
        gap: 12px;
        max-width: 400px;
      }
      .range-row input[type="range"] {
        flex: 1;
      }
      .range-value {
        font-size: 0.9rem;
        font-weight: 600;
        min-width: 24px;
        text-align: center;
      }

      /* Checkbox */
      .checkbox-row {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
      }
      .checkbox-row input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }

      /* Generate button */
      .generate-btn {
        padding: 10px 32px;
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.15s;
      }
      .generate-btn:hover {
        background: var(--accent-hover);
      }
      .generate-btn:disabled {
        background: #999;
        cursor: not-allowed;
      }

      /* Status text */
      .status-text {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-top: 12px;
      }
      .status-text.error {
        color: #d32f2f;
      }

      /* Output panel */
      .output-area {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .output-preview {
        width: 100%;
        max-width: 400px;
        aspect-ratio: 1;
        background: var(--preview-bg);
        border: 2px solid var(--border);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        margin-bottom: 12px;
        position: relative;
      }
      .output-preview img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }
      .overlay-img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        pointer-events: none;
        opacity: 0;
      }

      /* Variations strip */
      .variations-strip {
        width: 100%;
        margin-bottom: 12px;
        display: none;
      }
      .variations-strip.active {
        display: block;
      }
      .variations-strip .section-label {
        margin-bottom: 6px;
      }
      .variations-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }
      .variations-header .section-label {
        margin-bottom: 0;
      }
      .variations-spinner {
        font-size: 0.8rem;
        color: var(--text-muted);
      }
      .variations-scroll {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
      }
      .variations-thumb {
        aspect-ratio: 1;
        border-radius: 4px;
        border: 2px solid var(--border);
        overflow: hidden;
        cursor: pointer;
        transition: border-color 0.15s;
        position: relative;
      }
      .variations-thumb:hover {
        border-color: var(--accent);
      }
      .variations-thumb.selected {
        border-color: var(--accent);
        border-width: 3px;
      }
      .variations-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .variations-thumb.pending {
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--preview-bg);
      }
      .variations-thumb.pending::after {
        content: "";
        width: 16px;
        height: 16px;
        border: 2px solid var(--text-muted);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: varspin 0.8s linear infinite;
      }
      @keyframes varspin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Generate More dropdown */
      .more-wrap {
        position: relative;
        display: inline-block;
      }
      .more-btn {
        padding: 2px 10px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--input-bg);
        color: var(--text);
        cursor: pointer;
        font-size: 0.75rem;
        transition: all 0.15s;
      }
      .more-btn:hover {
        border-color: var(--text-muted);
        background: var(--preview-bg);
      }
      .more-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .more-menu {
        position: absolute;
        bottom: calc(100% + 4px);
        right: 0;
        z-index: 200;
        background: var(--panel-bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 4px 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 80px;
        display: none;
      }
      .more-menu.open {
        display: block;
      }
      .more-menu-item {
        padding: 5px 14px;
        font-size: 0.8rem;
        cursor: pointer;
        color: var(--text);
        text-align: right;
      }
      .more-menu-item:hover {
        background: var(--preview-bg);
      }

      /* Progress bar */
      .progress-bar-container {
        width: 100%;
        max-width: 400px;
        height: 6px;
        background: var(--border);
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 8px;
        display: none;
      }
      .progress-bar-container.active {
        display: block;
      }
      .progress-bar-fill {
        height: 100%;
        background: var(--accent);
        border-radius: 3px;
        transition: width 0.4s ease;
        width: 0%;
      }

      /* History strip */
      .history-strip {
        border-top: 1px solid var(--border);
        background: var(--panel-bg);
        padding: 12px 24px;
      }
      .history-strip .section-label {
        margin-bottom: 8px;
      }
      .history-scroll {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding-bottom: 4px;
      }
      .history-thumb {
        width: 64px;
        height: 64px;
        border-radius: 4px;
        border: 2px solid var(--border);
        overflow: hidden;
        cursor: pointer;
        flex-shrink: 0;
        transition: border-color 0.15s;
      }
      .history-thumb:hover {
        border-color: var(--accent);
      }
      .history-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .history-empty {
        color: var(--text-muted);
        font-size: 0.85rem;
      }

      /* Lightbox overlay */
      .lightbox {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        cursor: pointer;
      }
      .lightbox img {
        max-width: 80vw;
        max-height: 90vh;
        object-fit: contain;
        border-radius: 8px;
      }
      .lightbox-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 48px;
        height: 48px;
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        font-size: 2rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.15s;
      }
      .lightbox-nav:hover {
        color: #fff;
      }
      .lightbox-nav.prev {
        left: 16px;
      }
      .lightbox-nav.next {
        right: 16px;
      }
      .lightbox-counter {
        position: absolute;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%);
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.8rem;
      }
      .lightbox-use-sketch {
        position: absolute;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.55);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #fff;
        border-radius: 6px;
        padding: 8px 20px;
        font-size: 0.85rem;
        cursor: pointer;
        white-space: nowrap;
        transition: background 0.15s;
        z-index: 5;
      }
      .lightbox-use-sketch:hover {
        background: rgba(0, 0, 0, 0.8);
      }

      /* Live Sketch canvas */
      .canvas-wrapper {
        width: 100%;
        max-width: 400px;
        margin-bottom: 12px;
        position: relative;
      }
      .canvas-wrapper canvas {
        width: 100%;
        aspect-ratio: 1;
        border: 2px solid var(--border);
        border-radius: 8px;
        cursor: crosshair;
        touch-action: none;
        display: block;
        background-image: repeating-conic-gradient(#ccc 0% 25%, #fff 0% 50%);
        background-size: 16px 16px;
      }
      body.dark .canvas-wrapper canvas {
        background-image: repeating-conic-gradient(#444 0% 25%, #333 0% 50%);
      }
      .canvas-overlay-img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        pointer-events: none;
        border-radius: 8px;
        opacity: 0.2;
        display: none;
      }
      .canvas-toolbar {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
        max-width: 400px;
      }
      .tool-btn {
        padding: 6px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--input-bg);
        color: var(--text);
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.15s;
      }
      .tool-btn:hover {
        border-color: var(--text-muted);
        background: var(--preview-bg);
      }
      .tool-btn.active {
        border-color: var(--accent);
        background: var(--accent);
        color: #fff;
      }
      .canvas-toolbar .range-row {
        flex: 1;
        min-width: 120px;
      }
      .toolbar-overflow {
        display: contents;
      }
      .toolbar-more-btn {
        display: none;
        padding: 6px 10px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--input-bg);
        color: var(--text);
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 700;
        letter-spacing: 2px;
        line-height: 1;
      }
      .toolbar-more-btn:hover {
        border-color: var(--text-muted);
        background: var(--preview-bg);
      }
      .queue-status {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 4px;
      }

      /* Context menu */
      .ctx-menu {
        position: fixed;
        z-index: 200;
        background: var(--panel-bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 4px 0;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        min-width: 180px;
      }
      .ctx-menu-item {
        padding: 8px 16px;
        font-size: 0.85rem;
        cursor: pointer;
        color: var(--text);
      }
      .ctx-menu-item:hover {
        background: var(--preview-bg);
      }

      /* Use-as-sketch overlay button */
      .use-as-sketch-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.4);
        background: rgba(0, 0, 0, 0.45);
        color: #fff;
        font-size: 0.85rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 5;
        opacity: 0;
        transition: opacity 0.15s;
        line-height: 1;
        padding: 0;
      }
      .variations-thumb:hover .use-as-sketch-btn,
      .output-preview:hover .use-as-sketch-btn {
        opacity: 1;
      }
      @media (hover: none) {
        .use-as-sketch-btn {
          opacity: 0.8;
        }
      }

      /* Confirm modal */
      .confirm-modal {
        position: fixed;
        inset: 0;
        z-index: 300;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .confirm-dialog {
        background: var(--panel-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 24px;
        max-width: 360px;
        width: 90%;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
      .confirm-dialog p {
        font-size: 0.95rem;
        margin-bottom: 8px;
        color: var(--text);
      }
      .confirm-dialog .confirm-preview {
        width: 100%;
        aspect-ratio: 1;
        max-width: 200px;
        border-radius: 6px;
        border: 1px solid var(--border);
        object-fit: cover;
        margin: 12px auto;
        display: block;
      }
      .confirm-dialog .confirm-buttons {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 16px;
      }
      .confirm-dialog .confirm-btn {
        padding: 8px 20px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        border: 1px solid var(--border);
      }
      .confirm-dialog .confirm-btn.primary {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }
      .confirm-dialog .confirm-btn.primary:hover {
        background: var(--accent-hover);
      }
      .confirm-dialog .confirm-btn.secondary {
        background: var(--input-bg);
        color: var(--text);
      }
      .confirm-dialog .confirm-btn.secondary:hover {
        background: var(--preview-bg);
      }

      /* Image info */
      .img-info {
        font-family: Verdana, sans-serif;
        font-size: 0.65rem;
        color: var(--text-muted);
        margin-bottom: 6px;
        min-height: 1em;
      }

      /* Sessions modal */
      .sessions-modal {
        position: fixed;
        inset: 0;
        z-index: 300;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .sessions-dialog {
        background: var(--panel-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        width: 90%;
        max-width: 520px;
        max-height: 80vh;
        overflow-y: auto;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
      .sessions-dialog h2 {
        font-size: 1rem;
        margin-bottom: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .sessions-close {
        background: none;
        border: none;
        font-size: 1.3rem;
        cursor: pointer;
        color: var(--text-muted);
        padding: 0 4px;
        line-height: 1;
      }
      .sessions-close:hover {
        color: var(--text);
      }
      .session-row {
        border: 1px solid var(--border);
        border-radius: 6px;
        margin-bottom: 8px;
        overflow: hidden;
      }
      .session-header {
        padding: 10px 14px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.85rem;
        user-select: none;
      }
      .session-header:hover {
        background: var(--preview-bg);
      }
      .session-header .session-arrow {
        margin-right: 8px;
        display: inline-block;
        transition: transform 0.15s;
        font-size: 0.7rem;
      }
      .session-header .session-arrow.open {
        transform: rotate(90deg);
      }
      .session-body {
        padding: 10px 14px;
        border-top: 1px solid var(--border);
        display: none;
      }
      .session-body.open {
        display: block;
      }
      .session-thumbs {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 10px;
      }
      .session-thumbs img {
        width: 56px;
        height: 56px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid var(--border);
        cursor: pointer;
      }
      .session-actions {
        display: flex;
        gap: 8px;
      }
      .session-actions button {
        padding: 6px 14px;
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        border: 1px solid var(--border);
      }
      .session-actions .dl-zip {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }
      .session-actions .dl-zip:hover {
        background: var(--accent-hover);
      }
      .session-actions .del-session {
        background: var(--input-bg);
        color: #d32f2f;
        border-color: #d32f2f;
      }
      .session-actions .del-session:hover {
        background: #fdecea;
      }
      body.dark .session-actions .del-session:hover {
        background: #3a2020;
      }

      /* Settings menu */
      .settings-wrap {
        position: relative;
      }
      .settings-menu {
        position: absolute;
        top: calc(100% + 4px);
        right: 0;
        z-index: 250;
        background: var(--panel-bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 8px 0;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        min-width: 210px;
        display: none;
      }
      .settings-menu.open {
        display: block;
      }
      .settings-menu-section {
        padding: 4px 16px;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        font-weight: 600;
      }
      .settings-menu-item {
        padding: 6px 16px;
        font-size: 0.85rem;
        cursor: pointer;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .settings-menu-item:hover {
        background: var(--preview-bg);
      }
      .settings-menu-item .radio {
        width: 14px;
        height: 14px;
        border: 2px solid var(--border);
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }
      .settings-menu-item.active .radio {
        border-color: var(--accent);
      }
      .settings-menu-item.active .radio::after {
        content: "";
        width: 8px;
        height: 8px;
        background: var(--accent);
        border-radius: 50%;
      }

      /* Import actions row (Mode A) */
      .import-actions {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        max-width: 400px;
      }

      /* Preset chips (Modes B, D, E) */
      .preset-chips {
        display: flex;
        gap: 6px;
        margin-bottom: 12px;
        max-width: 400px;
        overflow-x: auto;
        align-items: center;
        padding-bottom: 4px;
      }
      .preset-chip {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        border: 2px solid var(--border);
        overflow: hidden;
        cursor: pointer;
        flex-shrink: 0;
        transition: border-color 0.15s;
      }
      .preset-chip:hover {
        border-color: var(--accent);
      }
      .preset-chip img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* Preset popover (Mode A) */
      .preset-popover {
        position: fixed;
        z-index: 200;
        background: var(--panel-bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 8px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        display: none;
      }
      .preset-popover.open {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        max-width: 300px;
      }
      .preset-popover .preset-chip {
        width: 48px;
        height: 48px;
      }

      /* Canvas drawer (Mode C) */
      .canvas-drawer {
        max-width: 400px;
        margin-bottom: 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 0;
        background: var(--panel-alt);
        display: none;
        overflow: hidden;
      }
      .canvas-drawer.open {
        display: block;
        padding: 12px;
      }
      .drawer-presets {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 8px;
      }
      .canvas-drawer-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 1px solid var(--border);
        background: var(--panel-bg);
        color: var(--text);
        font-size: 1.2rem;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 5;
        line-height: 1;
      }
      .canvas-drawer-btn:hover {
        background: var(--preview-bg);
      }

      /* Canvas drag-drop feedback */
      .canvas-wrapper.drop-active canvas {
        border-color: #2196f3 !important;
        border-style: dashed !important;
      }

      /* Mode E: full width panel */
      .panel-left.full-width {
        flex: 1 1 100%;
        border-right: none;
      }

      /* Toast notifications */
      .toast-container {
        position: fixed;
        top: 16px;
        right: 16px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 8px;
        pointer-events: none;
      }
      .toast {
        pointer-events: auto;
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 0.85rem;
        color: #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        animation:
          toast-in 0.25s ease-out,
          toast-out 0.3s ease-in forwards;
        animation-delay: 0s, 3.5s;
        max-width: 360px;
        word-break: break-word;
      }
      .toast.error {
        background: #d32f2f;
      }
      .toast.warn {
        background: #f57c00;
      }
      .toast.info {
        background: #1976d2;
      }
      .toast.success {
        background: #388e3c;
      }
      @keyframes toast-in {
        from {
          opacity: 0;
          transform: translateY(-12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes toast-out {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }

      /* Onboarding tooltip */
      .onboarding-tip {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--accent);
        color: #fff;
        padding: 12px 20px;
        border-radius: 10px;
        font-size: 0.95rem;
        font-weight: 500;
        z-index: 10;
        pointer-events: none;
        animation: pulse-tip 2s ease-in-out infinite;
      }
      @keyframes pulse-tip {
        0%,
        100% {
          opacity: 0.9;
          transform: translate(-50%, -50%) scale(1);
        }
        50% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1.04);
        }
      }

      /* Responsive — tablet */
      @media (max-width: 768px) {
        main {
          flex-direction: column;
        }
        .panel-left {
          border-right: none;
          border-bottom: 1px solid var(--border);
          max-width: 100%;
        }
        .panel-right {
          max-width: 100%;
        }
        .preview-container,
        .output-preview,
        .form-group input,
        .form-group textarea,
        .canvas-wrapper,
        .canvas-toolbar,
        .range-row,
        .overlay-controls,
        .progress-bar-container,
        .import-actions,
        .preset-chips,
        .canvas-drawer {
          max-width: 100%;
        }
        .canvas-wrapper canvas {
          width: 100%;
          height: auto;
        }
        header h1 {
          font-size: 1rem;
        }
        .header-right {
          gap: 8px;
          font-size: 0.8rem;
        }
        .variations-header {
          flex-wrap: wrap;
        }
        .history-scroll {
          max-height: 120px;
        }
      }
      /* Responsive — phone */
      @media (max-width: 480px) {
        header {
          padding: 8px 10px;
          flex-wrap: wrap;
          gap: 4px;
        }
        header h1 {
          font-size: 0.95rem;
          white-space: nowrap;
        }
        .header-right {
          gap: 6px;
          flex-wrap: wrap;
        }
        .gpu-stats .gpu-label {
          display: none;
        }
        .gpu-stats .gpu-bar {
          width: 36px;
        }
        .gpu-stats .gpu-text {
          font-size: 0.65rem;
          min-width: 0;
        }
        .usage-counter .usage-bar {
          width: 32px;
        }
        .usage-counter .usage-text {
          font-size: 0.65rem;
        }
        #sessionsBtn {
          padding: 4px 6px;
          font-size: 0.75rem;
        }
        .health-indicator span:not(.status-dot) {
          display: none;
        }
        .theme-toggle {
          padding: 4px 6px;
          font-size: 0.95rem;
        }
        .panel-left,
        .panel-right {
          padding: 10px;
        }
        .panel {
          padding: 10px;
        }
        .canvas-toolbar {
          gap: 4px;
        }
        .canvas-toolbar .tool-btn {
          padding: 4px 8px;
          font-size: 0.75rem;
        }
        .toolbar-overflow {
          display: none;
        }
        .toolbar-overflow.open {
          display: contents;
        }
        .toolbar-more-btn {
          display: inline-flex;
          align-items: center;
          padding: 4px 8px;
          font-size: 0.75rem;
        }
        .form-group label {
          font-size: 0.8rem;
        }
        .form-group textarea {
          min-height: 48px;
          font-size: 0.85rem;
        }
        .range-row {
          gap: 8px;
        }
        .history-strip {
          padding: 8px 10px;
        }
        .history-thumb {
          width: 52px;
          height: 52px;
        }
        .section-label {
          font-size: 0.7rem;
        }
        .variations-scroll {
          gap: 4px;
        }
        .variations-thumb img {
          width: 100%;
          height: 100%;
          object-fit: cover;
        }
      }

      /* Sketch tips bar */
      .sketch-tips {
        max-width: 400px;
        margin-bottom: 8px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .sketch-tip {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 6px;
        background: #fff3cd;
        color: #856404;
        font-size: 0.8rem;
        border: 1px solid #ffc107;
      }
      body.dark .sketch-tip {
        background: #3d3520;
        color: #ffc107;
        border-color: #665a2e;
      }
      .sketch-tip-icon {
        flex-shrink: 0;
        font-size: 0.9rem;
      }
      .sketch-tip-dismiss {
        margin-left: auto;
        background: none;
        border: none;
        cursor: pointer;
        color: inherit;
        opacity: 0.6;
        font-size: 0.9rem;
        padding: 0 2px;
      }
      .sketch-tip-dismiss:hover {
        opacity: 1;
      }

      /* Assist buttons */
      .assist-btn {
        padding: 2px 8px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--input-bg);
        color: var(--text-muted);
        cursor: pointer;
        font-size: 0.7rem;
        transition: all 0.15s;
      }
      .assist-btn:hover {
        border-color: var(--accent);
        color: var(--accent);
      }
      .assist-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .assist-btn.loading {
        opacity: 0.7;
        cursor: wait;
      }
      .prompt-label-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
      }
      .prompt-label-row label {
        margin-bottom: 0;
      }

      /* Suggestion chips */
      .suggestion-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        max-width: 400px;
        margin-bottom: 8px;
      }
      .suggestion-chip {
        padding: 4px 10px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--input-bg);
        color: var(--text);
        cursor: pointer;
        font-size: 0.78rem;
        transition: all 0.15s;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .suggestion-chip:hover {
        border-color: var(--accent);
        background: var(--accent);
        color: #fff;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  </head>
  <body>
    <div class="toast-container" id="toastContainer"></div>

    <header>
      <h1>LlamaSketch</h1>
      <div class="header-right">
        <div class="gpu-stats" id="gpuStats">
          <span class="gpu-label">VRAM</span>
          <div class="gpu-bar"><div class="gpu-bar-fill" id="gpuBarFill"></div></div>
          <span class="gpu-text" id="gpuText">--</span>
          <span class="gpu-label" id="gpuJobs"></span>
        </div>
        <div class="settings-wrap">
          <button class="theme-toggle" id="settingsBtn" title="Settings">&#9881;</button>
          <div class="settings-menu" id="settingsMenu">
            <div class="settings-menu-section">Layout</div>
            <div class="settings-menu-item" data-layout="A">
              <span class="radio"></span> Toolbar + Buttons
            </div>
            <div class="settings-menu-item" data-layout="B">
              <span class="radio"></span> Preset Chips
            </div>
            <div class="settings-menu-item" data-layout="C"><span class="radio"></span> Drawer</div>
            <div class="settings-menu-item" data-layout="D"><span class="radio"></span> Hybrid</div>
            <div class="settings-menu-item" data-layout="E">
              <span class="radio"></span> Merged Canvas
            </div>
          </div>
        </div>
        <div class="usage-counter" id="usageCounter" style="display: none">
          <div class="usage-bar"><div class="usage-bar-fill" id="usageBarFill"></div></div>
          <span class="usage-text" id="usageText"></span>
        </div>
        <button class="theme-toggle" id="sessionsBtn" title="Sessions">Sessions</button>
        <button class="theme-toggle" id="themeToggle" title="Toggle dark mode">&#9790;</button>
        <div class="health-indicator">
          <span class="status-dot disconnected" id="healthDot"></span>
          <span id="healthText">Checking...</span>
        </div>
      </div>
    </header>

    <main>
      <div class="panel panel-left">
        <div class="section-label">Input Sketch</div>

        <!-- Canvas (always visible) -->
        <div class="canvas-wrapper" id="canvasWrap" style="position: relative">
          <canvas id="sketchCanvas" width="512" height="512"></canvas>
          <img class="canvas-overlay-img" id="canvasOverlayImg" alt="" />
          <button class="canvas-drawer-btn" id="drawerBtn" title="Add preset or upload">+</button>
          <div class="onboarding-tip" id="onboardingTip" style="display: none">Draw something!</div>
        </div>
        <div class="canvas-toolbar">
          <button class="tool-btn active" id="pencilBtn" data-tool="pencil">Pencil</button>
          <button class="tool-btn" id="eraserBtn" data-tool="eraser">Eraser</button>
          <div class="range-row">
            <input type="range" id="strokeWidthInput" min="1" max="30" value="3" />
            <span class="range-value" id="strokeWidthValue">3</span>
          </div>
          <button class="tool-btn" id="clearCanvasBtn">Clear</button>
          <button class="tool-btn" id="undoBtn" disabled title="Undo (Ctrl+Z)">&#8630;</button>
          <button class="tool-btn" id="redoBtn" disabled title="Redo (Ctrl+Shift+Z)">
            &#8631;
          </button>
        </div>
        <div class="canvas-toolbar">
          <button class="tool-btn" id="loadSketchBtn">
            Upload
            <input
              type="file"
              id="loadSketchInput"
              accept="image/*"
              style="position: absolute; inset: 0; opacity: 0; cursor: pointer"
            />
          </button>
          <button class="toolbar-more-btn" id="toolbarMoreBtn" title="More tools">
            &middot;&middot;&middot;
          </button>
          <div class="toolbar-overflow" id="toolbarOverflow">
            <button class="tool-btn" id="saveSketchBtn">Save</button>
            <span style="width: 1px; height: 20px; background: var(--border); margin: 0 2px"></span>
            <button class="tool-btn" id="fitStretchBtn" data-fit="stretch">Stretch</button>
            <button class="tool-btn active" id="fitFillBtn" data-fit="fill">Fill</button>
            <button class="tool-btn" id="fitFitBtn" data-fit="fit">Fit</button>
          </div>
        </div>

        <!-- Import actions (Mode A) -->
        <div class="import-actions" id="importActions" style="display: none">
          <button class="tool-btn" id="presetDropdownBtn">+ Preset &#9662;</button>
          <button class="tool-btn" id="uploadActionBtn">+ Upload</button>
          <button class="tool-btn" id="pasteActionBtn">+ Paste</button>
        </div>

        <!-- Preset popover (Mode A) -->
        <div class="preset-popover" id="presetPopover"></div>

        <!-- Preset chips (Modes B, D, E) -->
        <div class="preset-chips" id="presetChips" style="display: none"></div>

        <!-- Canvas drawer (Mode C) -->
        <div class="canvas-drawer" id="canvasDrawer">
          <div class="section-label">Presets</div>
          <div class="drawer-presets" id="drawerPresets"></div>
          <div class="section-label" style="margin-top: 12px">Upload</div>
          <div class="drawer-upload">
            <button class="tool-btn" style="position: relative">
              Choose file...
              <input
                type="file"
                id="drawerFileInput"
                accept="image/*"
                style="position: absolute; inset: 0; opacity: 0; cursor: pointer"
              />
            </button>
          </div>
        </div>

        <div class="form-group" id="canvasOverlayControls" style="display: none">
          <label>Result overlay</label>
          <div class="range-row">
            <input type="range" id="canvasOverlayOpacity" min="0" max="100" value="20" />
            <span class="range-value" id="canvasOverlayOpacityValue">20%</span>
          </div>
        </div>
        <div class="img-info" id="canvasImgInfo"></div>
        <div class="queue-status" id="queueStatus"></div>
        <div class="sketch-tips" id="sketchTips"></div>

        <!-- Prompt (always visible) -->
        <div class="form-group">
          <div class="prompt-label-row">
            <label for="promptInput">Prompt</label>
            <button
              class="assist-btn"
              id="suggestBtn"
              style="display: none"
              title="AI: Identify sketch &amp; suggest prompt"
            >
              Suggest
            </button>
            <button
              class="assist-btn"
              id="enhanceBtn"
              style="display: none"
              title="AI: Enhance your prompt"
            >
              Enhance
            </button>
          </div>
          <textarea id="promptInput" placeholder="Describe the image you want..."></textarea>
          <div class="suggestion-chips" id="suggestionChips"></div>
        </div>

        <!-- Creativity slider (always visible) -->
        <div class="form-group">
          <label>Creativity (low = faithful to sketch, high = more creative)</label>
          <div class="range-row">
            <input type="range" id="denoiseInput" min="0" max="100" value="75" step="5" />
            <span class="range-value" id="denoiseValue">0.75</span>
          </div>
          <div
            id="creativityRangeInfo"
            style="
              display: none;
              font-size: 0.75rem;
              color: var(--text-muted);
              margin-top: 4px;
              align-items: center;
              gap: 8px;
            "
          >
            <span id="creativityRangeText"></span>
            <button
              class="tool-btn"
              id="creativityResetBtn"
              style="padding: 2px 8px; font-size: 0.7rem"
            >
              Reset range
            </button>
          </div>
        </div>

        <!-- Advanced controls (collapsible) -->
        <div style="margin-bottom: 12px; max-width: 400px">
          <button
            class="tool-btn"
            id="advancedToggle"
            style="font-size: 0.75rem; padding: 4px 10px"
          >
            Advanced &#9662;
          </button>
        </div>
        <div id="advancedControls" style="display: none; max-width: 400px; margin-bottom: 12px">
          <div class="form-group">
            <button class="tool-btn" id="randomPromptBtn" style="font-size: 0.8rem">
              Random prompt
            </button>
          </div>
          <div class="form-group">
            <label>Steps</label>
            <div class="range-row">
              <input type="range" id="stepsInput" min="1" max="50" value="4" />
              <span class="range-value" id="stepsValue">4</span>
            </div>
          </div>
          <div class="form-group" id="hdGroup">
            <label class="checkbox-row">
              <input type="checkbox" id="hdToggle" />
              <span
                >HD mode
                <small style="color: var(--text-muted)"
                  >(two-pass: 512 then upscale to 1024)</small
                ></span
              >
            </label>
          </div>
          <!-- Generate button (hidden — live mode always on) -->
          <button class="generate-btn" id="generateBtn" disabled style="display: none">
            Generate
          </button>
          <div class="status-text" id="statusText"></div>
        </div>

        <!-- Variations strip target for Mode E -->
        <div id="variationsStripTarget"></div>
      </div>

      <div class="panel panel-right">
        <div class="section-label">Output</div>
        <div class="output-area">
          <div class="output-preview" id="outputPreview">
            <span class="preview-placeholder">Result will appear here</span>
          </div>
          <div class="img-info" id="outputImgInfo"></div>
          <div class="variations-strip" id="variationsStrip">
            <div class="variations-header">
              <div class="section-label">Variations</div>
              <span class="variations-spinner" id="variationsSpinner"></span>
              <div class="more-wrap" id="moreWrap" style="display: none">
                <button class="more-btn" id="moreBtn">+ More &#9662;</button>
                <div class="more-menu" id="moreMenu">
                  <div class="more-menu-item" data-count="16">16</div>
                  <div class="more-menu-item" data-count="32">32</div>
                  <div class="more-menu-item" data-count="64">64</div>
                  <div class="more-menu-item" data-count="128">128</div>
                </div>
              </div>
            </div>
            <div class="variations-scroll" id="variationsScroll"></div>
          </div>
          <div class="progress-bar-container" id="progressBar">
            <div class="progress-bar-fill" id="progressFill"></div>
          </div>
          <div class="status-text" id="outputStatus"></div>
        </div>
      </div>
    </main>

    <div class="history-strip">
      <div class="section-label">History</div>
      <div class="history-scroll" id="historyScroll">
        <span class="history-empty" id="historyEmpty">No generations yet</span>
      </div>
    </div>

    <script>
      const $ = (sel) => document.querySelector(sel);
      const API = "";

      // ========================================================================
      // State
      // ========================================================================
      let selectedSketch = null; // preset id string
      let uploadedBase64 = null; // base64 string for uploaded image
      let polling = null;
      let currentLayout = localStorage.getItem("layoutMode") || "D";
      let fitMode = "fill"; // 'stretch' | 'fill' | 'fit'
      let sketchesData = []; // loaded preset data
      let creativityRange = null; // { min, max } in 0.00–1.00, or null = full range

      // Variety batch state
      const VARIETY_COUNT_PAID = 8;
      const VARIETY_IDLE_EXTRA_PAID = 8; // Additional variations after idle (paid only)
      const VARIETY_COUNT_FREE = 2; // Free mode: 2 variations, no idle extra
      const VARIETY_IDLE_MS = 10000; // 10 seconds idle before extra batch

      function isFreeMode() {
        return _usageDailyLimit > 0;
      }
      function getVarietyCount() {
        return isFreeMode() ? VARIETY_COUNT_FREE : VARIETY_COUNT_PAID;
      }
      function getVarietyIdleExtra() {
        return isFreeMode() ? 0 : VARIETY_IDLE_EXTRA_PAID;
      }
      let varietyIdleTimer = null;
      let varietyCapturedInputs = null; // { base64, prompt, steps, denoise } saved from first batch
      let varietyBatch = vbCreate(0); // pure batch state (synced from variety-batch.ts)
      let varietyThumbMap = new Map(); // externalId → thumbEl (DOM link)

      // ========================================================================
      // Queue Manager (synced copy of src/queue-manager.ts logic)
      // ========================================================================
      const MAX_QUEUE = 3;

      function createQueue() {
        return { submissions: [], sequenceNumber: 0 };
      }

      function queueAddSubmission(queue, jobId) {
        queue.sequenceNumber++;
        const entry = { jobId, seqNum: queue.sequenceNumber, status: "polling", pollTimer: null };
        let evicted = null;
        if (queue.submissions.length >= MAX_QUEUE) {
          queue.submissions.sort((a, b) => a.seqNum - b.seqNum);
          evicted = queue.submissions.shift();
        }
        queue.submissions.push(entry);
        return { entry, evicted };
      }

      function queueShouldDisplay(queue, entry) {
        if (entry.status !== "completed") return false;
        return !queue.submissions.some((e) => e.seqNum > entry.seqNum && e.status === "completed");
      }

      function queueFindEntry(queue, jobId) {
        return queue.submissions.find((e) => e.jobId === jobId);
      }

      function queueActiveCount(queue) {
        return queue.submissions.filter((e) => e.status === "pending" || e.status === "polling")
          .length;
      }

      const liveQueue = createQueue();

      // ========================================================================
      // Canvas Tools (synced copy of src/canvas-tools.ts logic)
      // ========================================================================
      let toolState = { tool: "pencil", strokeWidth: 3 };

      function getStrokeStyle() {
        return toolState.tool === "eraser" ? "destination-out" : "source-over";
      }

      function toCanvasCoords(cssX, cssY, cssWidth, cssHeight, canvasWidth, canvasHeight) {
        return { x: (cssX / cssWidth) * canvasWidth, y: (cssY / cssHeight) * canvasHeight };
      }

      // ========================================================================
      // Variety Batch (synced copy of src/variety-batch.ts logic)
      // ========================================================================
      function vbCreate(generation) {
        return { generation, jobs: [], totalFired: 0, onProgress: null, onAllDone: null };
      }

      function vbFireJobs(batch, count, submitFn) {
        const newJobs = [];
        for (let i = 0; i < count; i++) {
          const job = { id: batch.totalFired + i, externalId: null, status: "pending" };
          batch.jobs.push(job);
          newJobs.push(job);
          const gen = batch.generation;
          submitFn()
            .then((externalId) => {
              if (batch.generation !== gen) return;
              job.externalId = externalId;
              job.status = "submitted";
              _vbEmit(batch);
            })
            .catch(() => {
              if (batch.generation !== gen) return;
              job.status = "failed";
              _vbEmit(batch);
            });
        }
        batch.totalFired += count;
        return newJobs;
      }

      function vbComplete(batch, externalId) {
        const job = batch.jobs.find((j) => j.externalId === externalId && j.status === "submitted");
        if (!job) return false;
        job.status = "completed";
        _vbEmit(batch);
        return true;
      }

      function vbFail(batch, externalId) {
        const job = batch.jobs.find((j) => j.externalId === externalId && j.status === "submitted");
        if (!job) return false;
        job.status = "failed";
        _vbEmit(batch);
        return true;
      }

      function vbAbort(batch, cancelFn) {
        batch.generation++;
        for (const job of batch.jobs) {
          if (
            cancelFn &&
            job.externalId &&
            (job.status === "pending" || job.status === "submitted")
          ) {
            cancelFn(job.externalId);
          }
        }
        batch.jobs = [];
        batch.totalFired = 0;
      }

      function vbCompletedCount(batch) {
        return batch.jobs.filter((j) => j.status === "completed").length;
      }

      function vbSettledCount(batch) {
        return batch.jobs.filter((j) => j.status === "completed" || j.status === "failed").length;
      }

      function vbAllDone(batch) {
        return batch.jobs.length > 0 && vbSettledCount(batch) === batch.jobs.length;
      }

      function _vbEmit(batch) {
        const done = vbCompletedCount(batch);
        const total = batch.jobs.length;
        if (batch.onProgress) batch.onProgress(done, total);
        if (vbAllDone(batch) && batch.onAllDone) batch.onAllDone();
      }

      // ========================================================================
      // Sketch Analysis (synced copy of src/sketch-analysis.ts logic)
      // ========================================================================
      const SA_WHITE_THRESHOLD = 250;
      const SA_ALPHA_THRESHOLD = 128;

      function saIsStroke(data, i) {
        if (data[i + 3] < SA_ALPHA_THRESHOLD) return false;
        return (
          data[i] < SA_WHITE_THRESHOLD ||
          data[i + 1] < SA_WHITE_THRESHOLD ||
          data[i + 2] < SA_WHITE_THRESHOLD
        );
      }

      function saAnalyzeSketch(data, width, height) {
        let strokePixels = 0,
          sumX = 0,
          sumY = 0;
        let minX = width,
          minY = height,
          maxX = -1,
          maxY = -1;
        for (let y = 0; y < height; y++) {
          for (let x = 0; x < width; x++) {
            const i = (y * width + x) * 4;
            if (saIsStroke(data, i)) {
              strokePixels++;
              sumX += x;
              sumY += y;
              if (x < minX) minX = x;
              if (x > maxX) maxX = x;
              if (y < minY) minY = y;
              if (y > maxY) maxY = y;
            }
          }
        }
        const total = width * height;
        const coverage = total > 0 ? strokePixels / total : 0;
        if (strokePixels === 0)
          return {
            strokePixels: 0,
            coverage: 0,
            density: 0,
            boundingBox: null,
            centerOfMass: null,
          };
        const bb = { x: minX, y: minY, w: maxX - minX + 1, h: maxY - minY + 1 };
        const density = bb.w * bb.h > 0 ? strokePixels / (bb.w * bb.h) : 0;
        return {
          strokePixels,
          coverage,
          density,
          boundingBox: bb,
          centerOfMass: { x: Math.round(sumX / strokePixels), y: Math.round(sumY / strokePixels) },
        };
      }

      function saGenerateTips(stats, cw, ch) {
        if (stats.strokePixels === 0 || !stats.centerOfMass) return [];
        const tips = [];
        const diag = Math.sqrt(cw * cw + ch * ch);
        const dx = stats.centerOfMass.x - cw / 2;
        const dy = stats.centerOfMass.y - ch / 2;
        if (Math.sqrt(dx * dx + dy * dy) > diag * 0.25) {
          tips.push({
            id: "off-center",
            message: "Try centering your sketch for better results",
            priority: 1,
          });
        }
        if (stats.coverage < 0.05) {
          tips.push({
            id: "low-coverage",
            message: "Draw larger \u2014 small sketches may lose detail",
            priority: 2,
          });
        }
        if (stats.density < 0.05) {
          tips.push({
            id: "sparse",
            message: "Add more detail within your sketch area",
            priority: 3,
          });
        }
        tips.sort((a, b) => a.priority - b.priority);
        return tips;
      }

      // ========================================================================
      // Toast notifications
      // ========================================================================
      function showToast(message, type = "error") {
        const container = $("#toastContainer");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
      }

      // ========================================================================
      // Long-press handler (mobile "use as sketch" access)
      // ========================================================================
      function addLongPressHandler(element, callback, duration = 500) {
        let timer = null,
          startX = 0,
          startY = 0,
          fired = false;
        function onStart(e) {
          if (e.touches && e.touches.length > 1) return;
          fired = false;
          const t = e.touches ? e.touches[0] : e;
          startX = t.clientX;
          startY = t.clientY;
          timer = setTimeout(() => {
            fired = true;
            callback(e);
          }, duration);
        }
        function onMove(e) {
          if (!timer) return;
          const t = e.touches ? e.touches[0] : e;
          if (Math.abs(t.clientX - startX) > 10 || Math.abs(t.clientY - startY) > 10) {
            clearTimeout(timer);
            timer = null;
          }
        }
        function onEnd(e) {
          if (timer) {
            clearTimeout(timer);
            timer = null;
          }
          if (fired) {
            e.preventDefault();
            fired = false;
          }
        }
        element.addEventListener("touchstart", onStart, { passive: true });
        element.addEventListener("touchmove", onMove, { passive: true });
        element.addEventListener("touchend", onEnd);
        element.addEventListener("touchcancel", () => {
          if (timer) {
            clearTimeout(timer);
            timer = null;
          }
        });
      }

      function createUseAsSketchBtn(imageUrl) {
        const btn = document.createElement("button");
        btn.className = "use-as-sketch-btn";
        btn.innerHTML = "&#9998;";
        btn.title = "Use as input sketch";
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          confirmUseAsSketch(imageUrl);
        });
        return btn;
      }

      // ========================================================================
      // Onboarding
      // ========================================================================
      function initOnboarding() {
        if (localStorage.getItem("onboardingSeen")) return;
        const tip = $("#onboardingTip");
        tip.style.display = "";
        const dismiss = () => {
          tip.style.display = "none";
          localStorage.setItem("onboardingSeen", "1");
          canvas.removeEventListener("pointerdown", dismiss);
        };
        const canvas = $("#sketchCanvas");
        canvas.addEventListener("pointerdown", dismiss);
      }

      // ========================================================================
      // Health check
      // ========================================================================
      let _wasHealthy = true;
      async function checkHealth() {
        try {
          const res = await fetch(`${API}/api/health`);
          const data = await res.json();
          const dot = $("#healthDot");
          const text = $("#healthText");
          if (data.comfyui_reachable) {
            dot.className = "status-dot connected";
            text.textContent = "Connected";
            if (!_wasHealthy) showToast("GPU reconnected", "success");
            _wasHealthy = true;
          } else {
            dot.className = "status-dot disconnected";
            text.textContent = "Disconnected";
            if (_wasHealthy) showToast("GPU disconnected — generations paused", "warn");
            _wasHealthy = false;
          }
        } catch {
          $("#healthDot").className = "status-dot disconnected";
          $("#healthText").textContent = "Backend offline";
          if (_wasHealthy) showToast("Server unreachable", "error");
          _wasHealthy = false;
        }
      }

      // ========================================================================
      // GPU stats polling
      // ========================================================================
      async function pollGpuStats() {
        try {
          const res = await fetch(`${API}/api/gpu`);
          const data = await res.json();
          const total = data.vram_total;
          const free = data.vram_free;
          const fill = $("#gpuBarFill");
          const text = $("#gpuText");
          const jobsEl = $("#gpuJobs");

          if (total > 0) {
            const usedPct = Math.round(((total - free) / total) * 100);
            const usedGB = ((total - free) / 1024 ** 3).toFixed(1);
            const totalGB = (total / 1024 ** 3).toFixed(0);
            fill.style.width = usedPct + "%";
            fill.style.background = usedPct > 90 ? "#f44336" : usedPct > 70 ? "#ff9800" : "#4caf50";
            text.textContent = `${usedGB}/${totalGB}G`;
            text.title = `${data.gpu_name} — ${usedPct}% VRAM used`;
          } else {
            fill.style.width = "0%";
            text.textContent = "--";
            text.title = data.gpu_name;
          }

          if (data.active_jobs > 0) {
            jobsEl.textContent = `${data.active_jobs} job${data.active_jobs > 1 ? "s" : ""}`;
          } else {
            jobsEl.textContent = "";
          }
        } catch {
          $("#gpuBarFill").style.width = "0%";
          $("#gpuText").textContent = "--";
          $("#gpuJobs").textContent = "";
        }
      }

      // ========================================================================
      // Usage counter polling
      // ========================================================================
      let _usageDailyLimit = 0;
      let _usageToday = 0;
      let _usageRemaining = -1;

      async function pollUsage() {
        try {
          const res = await fetch(`${API}/api/usage`);
          const data = await res.json();
          _usageDailyLimit = data.daily_limit;
          _usageToday = data.today;
          _usageRemaining = data.remaining;
          updateUsageUI();
        } catch {
          /* silent */
        }
      }

      function updateUsageUI() {
        const el = $("#usageCounter");
        const fill = $("#usageBarFill");
        const text = $("#usageText");
        if (_usageDailyLimit <= 0) {
          el.style.display = "none";
          return;
        }

        el.style.display = "flex";
        const pct = Math.min(100, Math.round((_usageToday / _usageDailyLimit) * 100));
        fill.style.width = pct + "%";

        fill.classList.remove("warn", "critical");
        text.classList.remove("warn", "critical");
        if (pct >= 100) {
          fill.classList.add("critical");
          text.classList.add("critical");
        } else if (pct >= 75) {
          fill.classList.add("warn");
          text.classList.add("warn");
        }

        text.textContent = `${_usageToday}/${_usageDailyLimit}`;
        text.title =
          _usageRemaining > 0
            ? `${_usageRemaining} generation${_usageRemaining !== 1 ? "s" : ""} remaining today`
            : _usageRemaining === 0
              ? "Daily limit reached"
              : "";
      }

      function bumpUsageLocal() {
        if (_usageDailyLimit <= 0) return;
        _usageToday++;
        _usageRemaining = Math.max(0, _usageDailyLimit - _usageToday);
        updateUsageUI();
      }

      // ========================================================================
      // Settings menu
      // ========================================================================
      $("#settingsBtn").addEventListener("click", (e) => {
        e.stopPropagation();
        $("#settingsMenu").classList.toggle("open");
      });

      document.addEventListener("click", (e) => {
        if (!e.target.closest(".settings-wrap")) {
          $("#settingsMenu").classList.remove("open");
        }
      });

      $("#settingsMenu").addEventListener("click", (e) => {
        const item = e.target.closest(".settings-menu-item");
        if (!item) return;
        const mode = item.dataset.layout;
        if (mode) {
          applyLayout(mode);
          $("#settingsMenu").classList.remove("open");
        }
      });

      // ========================================================================
      // Layout system
      // ========================================================================
      function applyLayout(mode) {
        currentLayout = mode;
        localStorage.setItem("layoutMode", mode);

        // Update settings menu selection
        document.querySelectorAll(".settings-menu-item").forEach((item) => {
          item.classList.toggle("active", item.dataset.layout === mode);
        });

        const panelLeft = $(".panel-left");
        const panelRight = $(".panel-right");
        const importActions = $("#importActions");
        const presetChips = $("#presetChips");
        const canvasDrawer = $("#canvasDrawer");
        const drawerBtn = $("#drawerBtn");
        const variationsTarget = $("#variationsStripTarget");
        const variationsStrip = $("#variationsStrip");
        const canvasOvl = $("#canvasOverlayImg");

        // Reset all layout-specific states
        importActions.style.display = "none";
        presetChips.style.display = "none";
        canvasDrawer.classList.remove("open");
        drawerBtn.style.display = "none";
        panelRight.style.display = "";
        panelLeft.classList.remove("full-width");

        // Move variations strip back to panel-right if it was moved
        if (variationsStrip.parentElement === variationsTarget) {
          const outputArea = $(".output-area");
          const progressBar = $("#progressBar");
          outputArea.insertBefore(variationsStrip, progressBar);
        }

        // Reset canvas overlay opacity to slider value (Mode E overrides this)
        if (mode !== "E") {
          const savedOpacity = parseInt($("#canvasOverlayOpacity").value);
          canvasOvl.style.opacity = savedOpacity / 100;
        }

        // Remove upload chip if present (will be re-added for D/E)
        const existingUploadChip = $("#presetChips .upload-chip");
        if (existingUploadChip) existingUploadChip.remove();

        switch (mode) {
          case "A":
            importActions.style.display = "flex";
            break;
          case "B":
            presetChips.style.display = "flex";
            break;
          case "C":
            drawerBtn.style.display = "flex";
            break;
          case "D":
            presetChips.style.display = "flex";
            ensureUploadChip();
            break;
          case "E":
            presetChips.style.display = "flex";
            ensureUploadChip();
            panelRight.style.display = "none";
            panelLeft.classList.add("full-width");
            // Snap canvas overlay to 50%
            $("#canvasOverlayOpacity").value = 50;
            $("#canvasOverlayOpacityValue").textContent = "50%";
            canvasOvl.style.opacity = "0.5";
            // Always show canvas overlay controls in Mode E
            $("#canvasOverlayControls").style.display = "";
            if (canvasOvl.src) canvasOvl.style.display = "block";
            // Move variations strip to panel-left
            variationsTarget.appendChild(variationsStrip);
            break;
        }
      }

      function ensureUploadChip() {
        if ($("#presetChips .upload-chip")) return;
        const btn = document.createElement("button");
        btn.className = "tool-btn upload-chip";
        btn.textContent = "+ Upload";
        btn.style.cssText = "flex-shrink:0;font-size:0.75rem;padding:4px 10px;height:40px";
        btn.addEventListener("click", () => {
          const input = document.createElement("input");
          input.type = "file";
          input.accept = "image/*";
          input.addEventListener("change", (e) => handleFileToCanvas(e.target.files[0]));
          input.click();
        });
        $("#presetChips").appendChild(btn);
      }

      // ========================================================================
      // Load sketch presets
      // ========================================================================
      async function loadSketches() {
        try {
          const res = await fetch(`${API}/api/sketches`);
          sketchesData = await res.json();
          buildPresetUI();
        } catch (e) {
          console.error("Failed to load sketches:", e);
        }
      }

      function createPresetChip(sketch, onClick) {
        const chip = document.createElement("div");
        chip.className = "preset-chip";
        chip.title = sketch.name;
        const img = document.createElement("img");
        img.src = `${API}/api/sketches/${sketch.id}`;
        img.alt = sketch.name;
        chip.appendChild(img);
        chip.addEventListener("click", onClick);
        return chip;
      }

      function buildPresetUI() {
        // Chips (modes B, D, E)
        const chipsContainer = $("#presetChips");
        chipsContainer.querySelectorAll(".preset-chip").forEach((c) => c.remove());

        // Popover (mode A)
        const popover = $("#presetPopover");
        popover.innerHTML = "";

        // Drawer presets (mode C)
        const drawerPresets = $("#drawerPresets");
        drawerPresets.innerHTML = "";

        for (const s of sketchesData) {
          // Chip for preset chips row
          chipsContainer.appendChild(
            createPresetChip(s, () => loadPresetToCanvas(s.id, s.default_prompt)),
          );

          // Popover chip
          popover.appendChild(
            createPresetChip(s, () => {
              loadPresetToCanvas(s.id, s.default_prompt);
              popover.classList.remove("open");
            }),
          );

          // Drawer chip
          drawerPresets.appendChild(
            createPresetChip(s, () => {
              loadPresetToCanvas(s.id, s.default_prompt);
              $("#canvasDrawer").classList.remove("open");
            }),
          );
        }

        // Re-add upload chip if layout needs it
        if (currentLayout === "D" || currentLayout === "E") ensureUploadChip();
      }

      async function loadPresetToCanvas(id, defaultPrompt) {
        try {
          const res = await fetch(`${API}/api/sketches/${id}`);
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const img = new Image();
          img.onload = () => {
            pushUndoState();
            drawImageToCanvas(img);
            hasStrokes = true;
            updateOverlayImage();
            updateCanvasImgInfo();
            scheduleSubmit();
            URL.revokeObjectURL(url);
          };
          img.src = url;
          $("#promptInput").value = defaultPrompt;
        } catch (e) {
          console.error("Failed to load preset:", e);
        }
      }

      // ========================================================================
      // File to canvas (upload/drop/paste)
      // ========================================================================
      function handleFileToCanvas(file) {
        if (!file || !file.type.startsWith("image/")) return;
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => {
            pushUndoState();
            drawImageToCanvas(img);
            hasStrokes = true;
            updateOverlayImage();
            updateCanvasImgInfo();
            scheduleSubmit();
          };
          img.src = reader.result;
        };
        reader.readAsDataURL(file);
      }

      // ========================================================================
      // Creativity (synced copy of src/creativity.ts logic)
      // ========================================================================
      function crGetEffectiveRange(range) {
        if (!range) return { min: 0, max: 1 };
        const pad = 0.05;
        let min = Math.max(0, range.min - pad);
        let max = Math.min(1, range.max + pad);
        if (max - min < 0.1) {
          const mid = (min + max) / 2;
          min = Math.max(0, mid - 0.05);
          max = Math.min(1, mid + 0.05);
        }
        return { min, max };
      }

      function crSliderToDenoise(sliderPercent, range) {
        const { min, max } = crGetEffectiveRange(range);
        return min + sliderPercent * (max - min);
      }

      function crUpdateRange(current, newVal) {
        if (!current) return { min: newVal, max: newVal };
        return { min: Math.min(current.min, newVal), max: Math.max(current.max, newVal) };
      }

      // DOM wrappers
      function getEffectiveRange() {
        return crGetEffectiveRange(creativityRange);
      }

      function getDenoiseValue() {
        const slider = parseInt($("#denoiseInput").value) / 100;
        return crSliderToDenoise(slider, creativityRange);
      }

      function trackCreativity(val) {
        creativityRange = crUpdateRange(creativityRange, val);
        localStorage.setItem("creativityRange", JSON.stringify(creativityRange));
        updateCreativityRangeUI();
      }

      function updateCreativityRangeUI() {
        const el = $("#creativityRangeInfo");
        if (!creativityRange) {
          el.style.display = "none";
          return;
        }
        const { min, max } = getEffectiveRange();
        $("#creativityRangeText").textContent =
          `Slider range: ${min.toFixed(2)} \u2013 ${max.toFixed(2)}`;
        el.style.display = "flex";
        // Also refresh the displayed value
        $("#denoiseValue").textContent = getDenoiseValue().toFixed(2);
      }

      // ========================================================================
      // Sliders
      // ========================================================================
      $("#creativityResetBtn").addEventListener("click", () => {
        const currentVal = getDenoiseValue();
        creativityRange = null;
        localStorage.removeItem("creativityRange");
        $("#denoiseInput").value = Math.round(currentVal * 100);
        $("#denoiseValue").textContent = currentVal.toFixed(2);
        updateCreativityRangeUI();
      });

      $("#stepsInput").addEventListener("input", (e) => {
        $("#stepsValue").textContent = e.target.value;
      });
      $("#denoiseInput").addEventListener("input", (e) => {
        $("#denoiseValue").textContent = getDenoiseValue().toFixed(2);
        scheduleSubmit();
      });
      // Advanced toggle
      $("#advancedToggle").addEventListener("click", () => {
        const panel = $("#advancedControls");
        const btn = $("#advancedToggle");
        const open = panel.style.display !== "none";
        panel.style.display = open ? "none" : "block";
        btn.innerHTML = open ? "Advanced &#9662;" : "Advanced &#9652;";
      });

      // Random prompt button
      $("#randomPromptBtn").addEventListener("click", () => {
        const p = randomPrompt(3);
        if (p) {
          $("#promptInput").value = p;
          scheduleSubmit();
        }
      });

      $("#strokeWidthInput").addEventListener("input", (e) => {
        const val = parseInt(e.target.value);
        toolState.strokeWidth = Math.max(1, Math.min(30, val));
        $("#strokeWidthValue").textContent = toolState.strokeWidth;
      });

      // ========================================================================
      // Progress bar (STATUS_PROGRESS synced from src/format-utils.ts)
      // ========================================================================
      const STATUS_PROGRESS = {
        queued: 10,
        uploading: 25,
        submitted: 40,
        processing: 60,
        downloading: 85,
        completed: 100,
      };

      function setProgress(status) {
        const container = $("#progressBar");
        const fill = $("#progressFill");
        const pct = STATUS_PROGRESS[status];
        if (pct !== undefined) {
          container.classList.add("active");
          fill.style.width = pct + "%";
        }
        if (status === "completed" || status === "failed" || status === "cancelled") {
          // Hide after a short delay so the 100% state is visible
          setTimeout(
            () => {
              container.classList.remove("active");
              fill.style.width = "0%";
            },
            status === "completed" ? 600 : 0,
          );
        }
      }

      // ========================================================================
      // Generate (presets/upload modes)
      // ========================================================================
      $("#generateBtn").addEventListener("click", startGeneration);

      async function startGeneration() {
        const sketch = uploadedBase64 || selectedSketch;
        if (!sketch) return;

        const prompt = $("#promptInput").value.trim() || undefined;
        const steps = parseInt($("#stepsInput").value);
        const denoise = getDenoiseValue();
        const hd = $("#hdToggle").checked;
        trackCreativity(denoise);

        const btn = $("#generateBtn");
        btn.disabled = true;
        btn.textContent = "Generating...";
        $("#statusText").textContent = "";
        $("#statusText").className = "status-text";
        $("#outputStatus").textContent = "";
        $("#outputStatus").className = "status-text";

        // Clear output and show progress
        setOutputPlaceholder("Generating...");
        setProgress("queued");

        try {
          const res = await fetch(`${API}/api/generate`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sketch, prompt, steps, denoise, hd }),
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || "Generation failed");
          }

          const data = await res.json();
          pollJob(data.job_id);
        } catch (e) {
          btn.disabled = false;
          btn.textContent = "Generate";
          $("#statusText").textContent = `Error: ${e.message}`;
          $("#statusText").className = "status-text error";
        }
      }

      function pollJob(jobId) {
        if (polling) clearInterval(polling);

        polling = setInterval(async () => {
          try {
            const res = await fetch(`${API}/api/status/${jobId}`);
            const data = await res.json();
            const elapsed = data.elapsed_seconds ? `${data.elapsed_seconds}s` : "";
            $("#outputStatus").textContent =
              `Status: ${data.status}${elapsed ? ` (${elapsed})` : ""}`;
            setProgress(data.status);

            if (data.status === "completed") {
              clearInterval(polling);
              polling = null;
              showResult(jobId, elapsed);
              $("#generateBtn").disabled = false;
              $("#generateBtn").textContent = "Generate";
            } else if (data.status === "failed") {
              clearInterval(polling);
              polling = null;
              $("#outputStatus").textContent =
                `Failed: ${data.error || "Unknown error"} (${elapsed})`;
              $("#outputStatus").className = "status-text error";
              setOutputPlaceholder("Generation failed");
              $("#generateBtn").disabled = false;
              $("#generateBtn").textContent = "Generate";
            }
          } catch (e) {
            clearInterval(polling);
            polling = null;
            $("#outputStatus").textContent = "Error polling status";
            $("#outputStatus").className = "status-text error";
            $("#generateBtn").disabled = false;
            $("#generateBtn").textContent = "Generate";
          }
        }, 1000);
      }

      async function showResult(jobId, elapsed) {
        try {
          const res = await fetch(`${API}/api/result/${jobId}`);
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);

          setOutputImage(url);

          $("#outputStatus").textContent = `Completed (${elapsed})`;

          // Add to history
          addToHistory(url);
        } catch (e) {
          $("#outputStatus").textContent = "Error loading result";
          $("#outputStatus").className = "status-text error";
        }
      }

      function addToHistoryDOM(imageUrl) {
        const empty = $("#historyEmpty");
        if (empty) empty.remove();

        const scroll = $("#historyScroll");
        const thumb = document.createElement("div");
        thumb.className = "history-thumb";
        const img = document.createElement("img");
        img.src = imageUrl;
        thumb.appendChild(img);
        thumb.addEventListener("click", () => openLightbox(imageUrl));
        thumb.addEventListener("contextmenu", (e) => showImageContextMenu(e, imageUrl));
        addLongPressHandler(thumb, () => confirmUseAsSketch(imageUrl));
        scroll.prepend(thumb);
      }

      function addToHistory(imageUrl) {
        addToHistoryDOM(imageUrl);
        bumpUsageLocal();
        // Persist to IndexedDB
        if (db && currentSessionId) {
          fetch(imageUrl)
            .then((r) => r.blob())
            .then((blob) => dbSaveImage(blob))
            .catch(() => {});
        }
      }

      // ========================================================================
      // Context menu + confirm modal for "Use as input sketch"
      // ========================================================================
      let activeCtxMenu = null;
      let ctxMenuDismissHandler = null;

      function showImageContextMenu(e, imageUrl) {
        e.preventDefault();
        dismissCtxMenu();

        const menu = document.createElement("div");
        menu.className = "ctx-menu";

        const item = document.createElement("div");
        item.className = "ctx-menu-item";
        item.textContent = "Use as input sketch";
        item.addEventListener("click", () => {
          dismissCtxMenu();
          confirmUseAsSketch(imageUrl);
        });
        menu.appendChild(item);

        // "Cancel all generations" option — show when there are active jobs
        const hasActiveJobs =
          varietyBatch.jobs.some((j) => j.status === "pending" || j.status === "submitted") ||
          varietyIdleTimer ||
          queueActiveCount(liveQueue) > 0;
        if (hasActiveJobs) {
          const cancelItem = document.createElement("div");
          cancelItem.className = "ctx-menu-item";
          cancelItem.style.color = "#d32f2f";
          cancelItem.textContent = "Cancel all generations";
          cancelItem.addEventListener("click", () => {
            dismissCtxMenu();
            abortVarietyBatch();
            // Also cancel live queue jobs
            for (const entry of liveQueue.submissions) {
              if (entry.pollTimer) clearInterval(entry.pollTimer);
              if (entry.status === "pending" || entry.status === "polling") {
                fetch(`${API}/api/cancel/${entry.jobId}`, { method: "POST" }).catch(() => {});
              }
            }
            liveQueue.submissions = [];
            updateQueueStatus();
            setProgress("cancelled");
          });
          menu.appendChild(cancelItem);
        }

        // Position at cursor, clamp to viewport
        menu.style.left = Math.min(e.clientX, window.innerWidth - 200) + "px";
        menu.style.top = Math.min(e.clientY, window.innerHeight - 50) + "px";
        document.body.appendChild(menu);
        activeCtxMenu = menu;

        // Dismiss on click elsewhere or Escape
        setTimeout(() => {
          ctxMenuDismissHandler = () => dismissCtxMenu();
          document.addEventListener("click", ctxMenuDismissHandler);
          document.addEventListener("contextmenu", ctxMenuDismissHandler);
        }, 0);
      }

      function dismissCtxMenu() {
        if (activeCtxMenu) {
          activeCtxMenu.remove();
          activeCtxMenu = null;
        }
        if (ctxMenuDismissHandler) {
          document.removeEventListener("click", ctxMenuDismissHandler);
          document.removeEventListener("contextmenu", ctxMenuDismissHandler);
          ctxMenuDismissHandler = null;
        }
      }

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") dismissCtxMenu();
      });

      function confirmUseAsSketch(imageUrl) {
        const overlay = document.createElement("div");
        overlay.className = "confirm-modal";

        const dialog = document.createElement("div");
        dialog.className = "confirm-dialog";
        dialog.innerHTML = `
    <p><strong>Use as input sketch?</strong></p>
    <p style="font-size:0.8rem;color:var(--text-muted)">This will replace the current canvas content.</p>
    <img class="confirm-preview" src="${imageUrl}" alt="Preview">
    <div class="confirm-buttons">
      <button class="confirm-btn secondary" data-action="cancel">Cancel</button>
      <button class="confirm-btn primary" data-action="confirm">Use as sketch</button>
    </div>
  `;
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);

        // Close on backdrop click
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) overlay.remove();
        });

        dialog
          .querySelector('[data-action="cancel"]')
          .addEventListener("click", () => overlay.remove());
        dialog.querySelector('[data-action="confirm"]').addEventListener("click", () => {
          overlay.remove();
          applyAsSketchInput(imageUrl);
        });

        // Escape to close
        const onKey = (e) => {
          if (e.key === "Escape") {
            overlay.remove();
            document.removeEventListener("keydown", onKey);
          }
        };
        document.addEventListener("keydown", onKey);
      }

      function applyAsSketchInput(imageUrl) {
        const img = new Image();
        img.onload = () => {
          pushUndoState();
          drawImageToCanvas(img);
          hasStrokes = true;
          updateOverlayImage();
          updateCanvasImgInfo();
          scheduleSubmit();
        };
        img.src = imageUrl;
      }

      function getHistoryUrls() {
        return Array.from($("#historyScroll").querySelectorAll(".history-thumb img")).map(
          (img) => img.src,
        );
      }

      function openLightbox(src) {
        const urls = getHistoryUrls();
        let idx = urls.indexOf(src);
        if (idx < 0) idx = 0;

        const overlay = document.createElement("div");
        overlay.className = "lightbox";
        const img = document.createElement("img");
        img.src = src;

        const prevBtn = document.createElement("button");
        prevBtn.className = "lightbox-nav prev";
        prevBtn.innerHTML = "&#8249;";

        const nextBtn = document.createElement("button");
        nextBtn.className = "lightbox-nav next";
        nextBtn.innerHTML = "&#8250;";

        const counter = document.createElement("div");
        counter.className = "lightbox-counter";

        const useSketchBtn = document.createElement("button");
        useSketchBtn.className = "lightbox-use-sketch";
        useSketchBtn.textContent = "✏️ Use as sketch";

        overlay.appendChild(img);
        overlay.appendChild(prevBtn);
        overlay.appendChild(nextBtn);
        overlay.appendChild(counter);
        overlay.appendChild(useSketchBtn);
        document.body.appendChild(overlay);

        function show(i) {
          idx = (i + urls.length) % urls.length;
          img.src = urls[idx];
          counter.textContent = `${idx + 1} / ${urls.length}`;
        }
        show(idx);

        useSketchBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          overlay.remove();
          document.removeEventListener("keydown", onKey);
          confirmUseAsSketch(urls[idx]);
        });

        prevBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          show(idx - 1);
        });
        nextBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          show(idx + 1);
        });
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) overlay.remove();
        });

        const onKey = (e) => {
          if (e.key === "ArrowLeft") {
            show(idx - 1);
            e.preventDefault();
          } else if (e.key === "ArrowRight") {
            show(idx + 1);
            e.preventDefault();
          } else if (e.key === "Escape") {
            overlay.remove();
            document.removeEventListener("keydown", onKey);
          }
        };
        document.addEventListener("keydown", onKey);
      }

      // ========================================================================
      // Canvas drawing engine
      // ========================================================================
      const canvas = $("#sketchCanvas");
      const ctx = canvas.getContext("2d");
      let isDrawing = false;
      let debounceTimer = null;
      let hasStrokes = false;
      const undoStack = [];
      const redoStack = [];
      let strokeStartState = null;

      // Init canvas to transparent (checkerboard shows through)
      ctx.clearRect(0, 0, 512, 512);

      // ========================================================================
      // Undo / Redo
      // ========================================================================
      function pushUndoState() {
        undoStack.push(ctx.getImageData(0, 0, 512, 512));
        redoStack.length = 0;
        updateUndoRedoButtons();
      }

      function undo() {
        if (!undoStack.length) return;
        redoStack.push(ctx.getImageData(0, 0, 512, 512));
        ctx.putImageData(undoStack.pop(), 0, 0);
        hasStrokes = !isCanvasBlank();
        updateOverlayImage();
        updateCanvasImgInfo();
        scheduleSubmit();
        updateUndoRedoButtons();
      }

      function redo() {
        if (!redoStack.length) return;
        undoStack.push(ctx.getImageData(0, 0, 512, 512));
        ctx.putImageData(redoStack.pop(), 0, 0);
        hasStrokes = !isCanvasBlank();
        updateOverlayImage();
        updateCanvasImgInfo();
        scheduleSubmit();
        updateUndoRedoButtons();
      }

      function isCanvasBlank() {
        const d = ctx.getImageData(0, 0, 512, 512).data;
        for (let i = 3; i < d.length; i += 4) if (d[i] !== 0) return false;
        return true;
      }

      function updateUndoRedoButtons() {
        const u = $("#undoBtn"),
          r = $("#redoBtn");
        if (u) u.disabled = !undoStack.length;
        if (r) r.disabled = !redoStack.length;
      }

      // Tool buttons
      $("#pencilBtn").addEventListener("click", () => {
        toolState.tool = "pencil";
        $("#pencilBtn").classList.add("active");
        $("#eraserBtn").classList.remove("active");
      });
      $("#eraserBtn").addEventListener("click", () => {
        toolState.tool = "eraser";
        $("#eraserBtn").classList.add("active");
        $("#pencilBtn").classList.remove("active");
      });
      $("#clearCanvasBtn").addEventListener("click", () => {
        pushUndoState();
        ctx.clearRect(0, 0, 512, 512);
        hasStrokes = false;
        updateQueueStatus();
        updateOverlayImage();
        canvasOverlayImg.style.display = "none";
        $("#canvasOverlayControls").style.display = "none";
        abortVarietyBatch();
      });
      $("#undoBtn").addEventListener("click", undo);
      $("#redoBtn").addEventListener("click", redo);

      // Undo/redo keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") return;
        if ((e.ctrlKey || e.metaKey) && !e.altKey) {
          if (e.key === "z" && !e.shiftKey) {
            e.preventDefault();
            undo();
          } else if ((e.key === "z" && e.shiftKey) || e.key === "y") {
            e.preventDefault();
            redo();
          }
        }
      });

      // Toolbar overflow toggle (mobile)
      $("#toolbarMoreBtn").addEventListener("click", () => {
        $("#toolbarOverflow").classList.toggle("open");
      });

      // Save sketch to disk (transparent PNG)
      $("#saveSketchBtn").addEventListener("click", () => {
        const link = document.createElement("a");
        link.download = "sketch.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      });

      // Fit-mode buttons
      document.querySelectorAll("[data-fit]").forEach((btn) => {
        btn.addEventListener("click", () => {
          fitMode = btn.dataset.fit;
          document
            .querySelectorAll("[data-fit]")
            .forEach((b) => b.classList.toggle("active", b.dataset.fit === fitMode));
        });
      });

      // Image Layout (synced copy of src/image-layout.ts logic)
      function ilCalculateLayout(imgW, imgH, cw, ch, mode) {
        if (mode === "stretch") {
          return { sx: 0, sy: 0, sw: imgW, sh: imgH, dx: 0, dy: 0, dw: cw, dh: ch };
        }
        if (mode === "fill") {
          const scale = Math.max(cw / imgW, ch / imgH);
          const sw = cw / scale,
            sh = ch / scale;
          const sx = (imgW - sw) / 2,
            sy = (imgH - sh) / 2;
          return { sx, sy, sw, sh, dx: 0, dy: 0, dw: cw, dh: ch };
        }
        // fit
        const scale = Math.min(cw / imgW, ch / imgH);
        const dw = imgW * scale,
          dh = imgH * scale;
        const dx = (cw - dw) / 2,
          dy = (ch - dh) / 2;
        return { sx: 0, sy: 0, sw: imgW, sh: imgH, dx, dy, dw, dh };
      }

      // Draw an image to the canvas respecting current fitMode
      function drawImageToCanvas(img) {
        const cw = 512,
          ch = 512;
        ctx.clearRect(0, 0, cw, ch);
        const r = ilCalculateLayout(img.width, img.height, cw, ch, fitMode);
        if (fitMode === "fit") {
          ctx.fillStyle = "#ffffff";
          ctx.fillRect(0, 0, cw, ch);
        }
        ctx.drawImage(img, r.sx, r.sy, r.sw, r.sh, r.dx, r.dy, r.dw, r.dh);
      }

      // Load sketch from disk
      $("#loadSketchBtn").style.position = "relative";
      $("#loadSketchInput").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => {
            pushUndoState();
            drawImageToCanvas(img);
            hasStrokes = true;
            updateOverlayImage();
            updateCanvasImgInfo();
            scheduleSubmit();
          };
          img.src = reader.result;
        };
        reader.readAsDataURL(file);
        e.target.value = ""; // allow re-loading same file
      });

      function getCanvasPoint(e) {
        const rect = canvas.getBoundingClientRect();
        let clientX, clientY;
        if (e.touches) {
          clientX = e.touches[0].clientX;
          clientY = e.touches[0].clientY;
        } else {
          clientX = e.clientX;
          clientY = e.clientY;
        }
        return toCanvasCoords(
          clientX - rect.left,
          clientY - rect.top,
          rect.width,
          rect.height,
          512,
          512,
        );
      }

      function startStroke(e) {
        e.preventDefault();
        strokeStartState = ctx.getImageData(0, 0, 512, 512);
        isDrawing = true;
        const pt = getCanvasPoint(e);
        ctx.globalCompositeOperation = getStrokeStyle();
        ctx.beginPath();
        ctx.moveTo(pt.x, pt.y);
        ctx.strokeStyle = "#000000";
        ctx.lineWidth = toolState.strokeWidth;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
      }

      function continueStroke(e) {
        if (!isDrawing) return;
        e.preventDefault();
        const pt = getCanvasPoint(e);
        ctx.lineTo(pt.x, pt.y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(pt.x, pt.y);
      }

      function endStroke(e) {
        if (!isDrawing) return;
        e.preventDefault();
        isDrawing = false;
        ctx.globalCompositeOperation = "source-over";
        if (strokeStartState) {
          undoStack.push(strokeStartState);
          redoStack.length = 0;
          strokeStartState = null;
          updateUndoRedoButtons();
        }
        hasStrokes = true;
        updateOverlayImage();
        updateCanvasImgInfo();
        // Debounce submission
        scheduleSubmit();
      }

      // Mouse events
      canvas.addEventListener("mousedown", startStroke);
      canvas.addEventListener("mousemove", continueStroke);
      canvas.addEventListener("mouseup", endStroke);
      canvas.addEventListener("mouseleave", endStroke);

      // Touch events
      canvas.addEventListener("touchstart", startStroke, { passive: false });
      canvas.addEventListener("touchmove", continueStroke, { passive: false });
      canvas.addEventListener("touchend", endStroke, { passive: false });
      canvas.addEventListener("touchcancel", endStroke, { passive: false });

      // ========================================================================
      // Live queue submission
      // ========================================================================
      function canvasToWhiteBgDataURL() {
        // Composite canvas onto white background for export (transparent = white, not black)
        const tmp = document.createElement("canvas");
        tmp.width = canvas.width;
        tmp.height = canvas.height;
        const tctx = tmp.getContext("2d");
        tctx.fillStyle = "#ffffff";
        tctx.fillRect(0, 0, tmp.width, tmp.height);
        tctx.drawImage(canvas, 0, 0);
        return tmp.toDataURL("image/png");
      }

      async function submitCanvasToQueue() {
        // Get canvas as base64 (with white background)
        const dataUrl = canvasToWhiteBgDataURL();
        const base64 = dataUrl.split(",")[1];

        const prompt = $("#promptInput")?.value?.trim() || undefined;
        const steps = parseInt($("#stepsInput").value);
        const denoise = getDenoiseValue();
        trackCreativity(denoise);

        try {
          const res = await fetch(`${API}/api/generate`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sketch: base64, prompt, steps, denoise, hd: false }),
          });

          if (!res.ok) {
            console.error("Live submit failed:", res.status);
            if (res.status === 429) {
              const err = await res.json().catch(() => ({}));
              const detail = err.detail || "";
              if (detail.includes("Daily limit")) {
                showToast(`${detail}`, "error");
                pollUsage();
              } else {
                showToast("Too many requests — slow down", "warn");
              }
            } else {
              showToast("Generation failed — server error", "error");
            }
            return;
          }

          const data = await res.json();
          const { entry, evicted } = queueAddSubmission(liveQueue, data.job_id);

          // Cancel evicted job (fire-and-forget)
          if (evicted) {
            if (evicted.pollTimer) clearInterval(evicted.pollTimer);
            fetch(`${API}/api/cancel/${evicted.jobId}`, { method: "POST" }).catch(() => {});
          }

          // Start polling this job
          entry.pollTimer = setInterval(() => pollLiveJob(entry), 1000);
          updateQueueStatus();
        } catch (e) {
          console.error("Live submit error:", e);
          showToast("Could not reach server — check connection", "error");
        }
      }

      async function pollLiveJob(entry) {
        try {
          const res = await fetch(`${API}/api/status/${entry.jobId}`);
          const data = await res.json();

          setProgress(data.status);

          if (data.status === "completed") {
            entry.status = "completed";
            if (entry.pollTimer) {
              clearInterval(entry.pollTimer);
              entry.pollTimer = null;
            }

            if (queueShouldDisplay(liveQueue, entry)) {
              await showLiveResult(entry.jobId);
            }
            updateQueueStatus();
          } else if (data.status === "failed" || data.status === "cancelled") {
            entry.status = data.status;
            if (entry.pollTimer) {
              clearInterval(entry.pollTimer);
              entry.pollTimer = null;
            }
            updateQueueStatus();
          }
        } catch (e) {
          entry.status = "failed";
          if (entry.pollTimer) {
            clearInterval(entry.pollTimer);
            entry.pollTimer = null;
          }
          updateQueueStatus();
        }
      }

      async function showLiveResult(jobId) {
        try {
          const res = await fetch(`${API}/api/result/${jobId}`);
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);

          setOutputImage(url);
          updateCanvasOverlay(url);

          $("#outputStatus").textContent = "Live result";
          $("#outputStatus").className = "status-text";

          addToHistory(url);

          // Fire variety batch after first live result
          startVarietyBatch();
        } catch (e) {
          console.error("Error loading live result:", e);
          showToast("Failed to load generated image", "error");
        }
      }

      function updateQueueStatus() {
        const count = queueActiveCount(liveQueue);
        const el = $("#queueStatus");
        if (count > 0) {
          el.textContent = `${count} generation${count > 1 ? "s" : ""} in queue`;
        } else if (hasStrokes) {
          el.textContent = "Draw to generate";
        } else {
          el.textContent = "";
        }
      }

      // ========================================================================
      // Variety batch manager (uses synced variety-batch.ts pure functions)
      // ========================================================================
      let varietyPollTimers = new Map(); // externalId → interval timer

      function startVarietyBatch() {
        abortVarietyBatch();

        // New batch with bumped generation
        varietyBatch = vbCreate(varietyBatch.generation + 1);

        // Capture current inputs for this batch (and potential idle extension)
        const dataUrl = canvasToWhiteBgDataURL();
        varietyCapturedInputs = {
          base64: dataUrl.split(",")[1],
          prompt: $("#promptInput")?.value?.trim() || undefined,
          steps: parseInt($("#stepsInput").value),
          denoise: getDenoiseValue(),
        };

        // Wire progress/completion callbacks
        varietyBatch.onProgress = (completed, total) => {
          updateVarietySpinner();
        };
        varietyBatch.onAllDone = () => {
          updateVarietySpinner();
          // If first batch just finished, start idle timer for extension (paid mode only)
          const count = getVarietyCount();
          const idleExtra = getVarietyIdleExtra();
          if (idleExtra > 0 && varietyBatch.totalFired === count && varietyCapturedInputs) {
            if (varietyIdleTimer) clearTimeout(varietyIdleTimer);
            varietyIdleTimer = setTimeout(() => {
              varietyIdleTimer = null;
              if (varietyBatch.totalFired === count && varietyCapturedInputs) {
                fireVarietyJobs(idleExtra);
              }
            }, VARIETY_IDLE_MS);
          }
        };

        // Show strip and clear contents
        $("#variationsStrip").classList.add("active");
        $("#variationsScroll").innerHTML = "";
        varietyThumbMap = new Map();

        fireVarietyJobs(getVarietyCount());
      }

      function fireVarietyJobs(count) {
        const { base64, prompt, steps, denoise } = varietyCapturedInputs;
        const scroll = $("#variationsScroll");

        // Create placeholder thumbs for each job
        const placeholders = [];
        for (let i = 0; i < count; i++) {
          const thumbEl = document.createElement("div");
          thumbEl.className = "variations-thumb pending";
          scroll.appendChild(thumbEl);
          placeholders.push(thumbEl);
        }

        let idx = 0;
        const submitFn = async () => {
          const res = await fetch(`${API}/api/generate`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sketch: base64, prompt, steps, denoise, hd: false }),
          });
          if (!res.ok) throw new Error("submit failed");
          const data = await res.json();
          const jobId = data.job_id;
          // Link thumb to this external id
          const thumb = placeholders[idx++];
          varietyThumbMap.set(jobId, thumb);
          // Start polling
          const gen = varietyBatch.generation;
          const timer = setInterval(() => pollVarietyJob(jobId, gen), 1000);
          varietyPollTimers.set(jobId, timer);
          return jobId;
        };

        vbFireJobs(varietyBatch, count, submitFn);
        updateVarietySpinner();
      }

      function updateVarietySpinner() {
        const spinner = $("#variationsSpinner");
        const completed = vbCompletedCount(varietyBatch);
        const total = varietyBatch.jobs.length;
        const done = vbAllDone(varietyBatch);

        if (done || total === 0) {
          spinner.textContent = "";
        } else {
          spinner.textContent = `Generating... ${completed}/${total}`;
        }

        // Show "More" button when all initial variations are done (paid mode only)
        const moreWrap = $("#moreWrap");
        const count = getVarietyCount();
        const idleExtra = getVarietyIdleExtra();
        const maxInitial = count + idleExtra;
        if (!isFreeMode() && done && total >= maxInitial && varietyCapturedInputs) {
          moreWrap.style.display = "";
          $("#moreBtn").disabled = false;
        } else if (!isFreeMode() && !done && total > maxInitial) {
          // Bulk in progress — show but disabled
          moreWrap.style.display = "";
          $("#moreBtn").disabled = true;
        } else {
          moreWrap.style.display = "none";
        }
      }

      async function pollVarietyJob(externalId, gen) {
        // Guard: stop polling if batch was replaced
        if (gen !== varietyBatch.generation) {
          const timer = varietyPollTimers.get(externalId);
          if (timer) {
            clearInterval(timer);
            varietyPollTimers.delete(externalId);
          }
          return;
        }

        try {
          const res = await fetch(`${API}/api/status/${externalId}`);
          const data = await res.json();

          if (data.status === "completed") {
            const timer = varietyPollTimers.get(externalId);
            if (timer) {
              clearInterval(timer);
              varietyPollTimers.delete(externalId);
            }

            // Fetch result image
            const imgRes = await fetch(`${API}/api/result/${externalId}`);
            const blob = await imgRes.blob();
            const url = URL.createObjectURL(blob);

            // Replace placeholder with image
            const thumbEl = varietyThumbMap.get(externalId);
            if (thumbEl) {
              thumbEl.classList.remove("pending");
              thumbEl.innerHTML = "";
              const img = document.createElement("img");
              img.src = url;
              thumbEl.appendChild(img);

              // Click handler: show in main output
              thumbEl.addEventListener("click", () => {
                setOutputImage(url);
                updateCanvasOverlay(url);
                document
                  .querySelectorAll(".variations-thumb")
                  .forEach((t) => t.classList.remove("selected"));
                thumbEl.classList.add("selected");
              });
              thumbEl.addEventListener("contextmenu", (e) => showImageContextMenu(e, url));
              thumbEl.appendChild(createUseAsSketchBtn(url));
              addLongPressHandler(thumbEl, () => confirmUseAsSketch(url));
            }

            addToHistory(url);
            vbComplete(varietyBatch, externalId);
          } else if (data.status === "failed" || data.status === "cancelled") {
            const timer = varietyPollTimers.get(externalId);
            if (timer) {
              clearInterval(timer);
              varietyPollTimers.delete(externalId);
            }
            const thumbEl = varietyThumbMap.get(externalId);
            if (thumbEl) thumbEl.remove();
            vbFail(varietyBatch, externalId);
          }
        } catch (e) {
          const timer = varietyPollTimers.get(externalId);
          if (timer) {
            clearInterval(timer);
            varietyPollTimers.delete(externalId);
          }
          const thumbEl = varietyThumbMap.get(externalId);
          if (thumbEl) thumbEl.remove();
          vbFail(varietyBatch, externalId);
        }
      }

      function abortVarietyBatch() {
        if (varietyIdleTimer) {
          clearTimeout(varietyIdleTimer);
          varietyIdleTimer = null;
        }
        // Clear poll timers
        for (const [, timer] of varietyPollTimers) clearInterval(timer);
        varietyPollTimers = new Map();
        // Abort pure batch (cancels via API)
        vbAbort(varietyBatch, (externalId) => {
          fetch(`${API}/api/cancel/${externalId}`, { method: "POST" }).catch(() => {});
        });
        varietyCapturedInputs = null;
        varietyThumbMap = new Map();
        $("#variationsStrip").classList.remove("active");
        $("#variationsScroll").innerHTML = "";
        $("#variationsSpinner").textContent = "";
        $("#moreWrap").style.display = "none";
        $("#moreMenu").classList.remove("open");
      }

      // ========================================================================
      // "Generate More" dropdown
      // ========================================================================
      $("#moreBtn").addEventListener("click", (e) => {
        e.stopPropagation();
        $("#moreMenu").classList.toggle("open");
      });

      document.addEventListener("click", (e) => {
        if (!e.target.closest(".more-wrap")) {
          $("#moreMenu").classList.remove("open");
        }
      });

      $("#moreMenu").addEventListener("click", (e) => {
        const item = e.target.closest(".more-menu-item");
        if (!item) return;
        const count = parseInt(item.dataset.count);
        if (!count || !varietyCapturedInputs) return;

        $("#moreMenu").classList.remove("open");

        // Update onAllDone to re-enable the button after this bulk batch
        varietyBatch.onAllDone = () => {
          updateVarietySpinner();
        };

        fireVarietyJobs(count);
        updateVarietySpinner();
      });

      // ========================================================================
      // Dark mode toggle
      // ========================================================================
      (function initTheme() {
        const saved = localStorage.getItem("theme");
        if (saved === "dark") document.body.classList.add("dark");
        updateThemeIcon();
      })();

      $("#themeToggle").addEventListener("click", () => {
        document.body.classList.toggle("dark");
        localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
        updateThemeIcon();
      });

      function updateThemeIcon() {
        $("#themeToggle").innerHTML = document.body.classList.contains("dark")
          ? "&#9788;"
          : "&#9790;";
      }

      // ========================================================================
      // Output overlay
      // ========================================================================
      const overlayImg = document.createElement("img");
      overlayImg.className = "overlay-img";
      $("#outputPreview").appendChild(overlayImg);

      // Persistent "use as sketch" button for output preview
      const outputSketchBtn = document.createElement("button");
      outputSketchBtn.className = "use-as-sketch-btn";
      outputSketchBtn.innerHTML = "&#9998;";
      outputSketchBtn.title = "Use as input sketch";
      outputSketchBtn.style.display = "none";
      $("#outputPreview").appendChild(outputSketchBtn);
      outputSketchBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const img = $("#outputPreview").querySelector(
          "img:not(.overlay-img):not(.use-as-sketch-btn)",
        );
        if (img && img.src) confirmUseAsSketch(img.src);
      });
      addLongPressHandler($("#outputPreview"), () => {
        const img = $("#outputPreview").querySelector(
          "img:not(.overlay-img):not(.use-as-sketch-btn)",
        );
        if (img && img.src) confirmUseAsSketch(img.src);
      });

      $("#outputPreview").addEventListener("contextmenu", (e) => {
        const img = $("#outputPreview").querySelector("img:not(.overlay-img)");
        if (img && img.src) {
          showImageContextMenu(e, img.src);
        }
      });

      function updateOverlayImage() {
        overlayImg.src = canvas.toDataURL("image/png");
      }

      function setOutputImage(url) {
        const container = $("#outputPreview");
        // Remove all children except overlay img and sketch button
        Array.from(container.children).forEach((child) => {
          if (child !== overlayImg && child !== outputSketchBtn) container.removeChild(child);
        });
        const img = document.createElement("img");
        img.src = url;
        img.onload = () =>
          updateImgInfoFromUrl(url, img.naturalWidth, img.naturalHeight, "#outputImgInfo");
        container.insertBefore(img, overlayImg);
        outputSketchBtn.style.display = "";
      }

      function setOutputPlaceholder(text) {
        const container = $("#outputPreview");
        Array.from(container.children).forEach((child) => {
          if (child !== overlayImg && child !== outputSketchBtn) container.removeChild(child);
        });
        const span = document.createElement("span");
        span.className = "preview-placeholder";
        span.textContent = text;
        container.insertBefore(span, overlayImg);
        outputSketchBtn.style.display = "none";
      }

      // ========================================================================
      // Canvas overlay (output over input)
      // ========================================================================
      const canvasOverlayImg = $("#canvasOverlayImg");

      $("#canvasOverlayOpacity").addEventListener("input", (e) => {
        const val = parseInt(e.target.value);
        canvasOverlayImg.style.opacity = val / 100;
        $("#canvasOverlayOpacityValue").textContent = val + "%";
      });

      function updateCanvasOverlay(url) {
        canvasOverlayImg.src = url;
        canvasOverlayImg.style.display = "block";
        $("#canvasOverlayControls").style.display = "";
      }

      // ========================================================================
      // Format Utils (synced copy of src/format-utils.ts logic)
      // ========================================================================
      function fmtSize(bytes) {
        if (bytes >= 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + " MB";
        return (bytes / 1024).toFixed(1) + " KB";
      }

      function fmtRandomPrompt(wl, count = 3) {
        if (!wl.length) return "";
        const words = [];
        for (let i = 0; i < count; i++) {
          words.push(wl[Math.floor(Math.random() * wl.length)]);
        }
        return words.join(" ");
      }

      function updateImgInfo(el, w, h, sizeBytes) {
        if (!el) return;
        el.textContent = `${w}\u00D7${h} px \u2022 ${fmtSize(sizeBytes)}`;
      }

      function updateImgInfoFromUrl(url, w, h, selector) {
        const el = $(selector);
        if (!el) return;
        fetch(url)
          .then((r) => r.blob())
          .then((blob) => {
            updateImgInfo(el, w, h, blob.size);
          })
          .catch(() => {
            el.textContent = `${w}\u00D7${h} px`;
          });
      }

      function updateCanvasImgInfo() {
        const el = $("#canvasImgInfo");
        if (!el) return;
        canvas.toBlob((blob) => {
          if (blob) updateImgInfo(el, canvas.width, canvas.height, blob.size);
        });
      }

      // ========================================================================
      // Sketch Tips (Layer 1) + AI Assist (Layers 2+3)
      // ========================================================================
      const _dismissedTips = (() => {
        try {
          return JSON.parse(localStorage.getItem("dismissedTips") || "{}");
        } catch {
          return {};
        }
      })();
      let _assistEnabled = false;

      function updateSketchTips() {
        const container = $("#sketchTips");
        if (!container) return;
        const canvas = $("#sketchCanvas");
        if (!canvas) {
          container.innerHTML = "";
          return;
        }
        const ctx = canvas.getContext("2d");
        const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        const stats = saAnalyzeSketch(data, canvas.width, canvas.height);
        const tips = saGenerateTips(stats, canvas.width, canvas.height).filter(
          (t) => !_dismissedTips[t.id],
        );
        container.innerHTML = "";
        tips.forEach((t) => {
          const row = document.createElement("div");
          row.className = "sketch-tip";
          row.dataset.tipId = t.id;
          const icon = document.createElement("span");
          icon.className = "sketch-tip-icon";
          icon.textContent = "\u{1F4A1}";
          const msg = document.createElement("span");
          msg.textContent = t.message;
          const dismiss = document.createElement("button");
          dismiss.className = "sketch-tip-dismiss";
          dismiss.title = "Dismiss";
          dismiss.textContent = "\u00D7";
          dismiss.addEventListener("click", () => {
            _dismissedTips[t.id] = true;
            localStorage.setItem("dismissedTips", JSON.stringify(_dismissedTips));
            row.remove();
          });
          row.append(icon, msg, dismiss);
          container.appendChild(row);
        });
      }

      function setSuggestionChips(chips) {
        const container = $("#suggestionChips");
        if (!container) return;
        container.innerHTML = "";
        chips.forEach((text) => {
          const chip = document.createElement("div");
          chip.className = "suggestion-chip";
          chip.textContent = text;
          chip.title = text;
          chip.addEventListener("click", () => {
            $("#promptInput").value = text;
            container.innerHTML = "";
            scheduleSubmit();
          });
          container.appendChild(chip);
        });
      }

      async function checkAssistConfig() {
        try {
          const res = await fetch(`${API}/api/config`);
          const data = await res.json();
          _assistEnabled = !!data.assist_enabled;
          const suggestBtn = $("#suggestBtn");
          const enhanceBtn = $("#enhanceBtn");
          if (suggestBtn) suggestBtn.style.display = _assistEnabled ? "" : "none";
          if (enhanceBtn) enhanceBtn.style.display = _assistEnabled ? "" : "none";
        } catch {
          /* assist stays hidden */
        }
      }

      async function onSuggestClick() {
        const btn = $("#suggestBtn");
        if (!btn || btn.disabled) return;
        btn.disabled = true;
        btn.classList.add("loading");
        btn.textContent = "Thinking\u2026";
        try {
          const canvas = $("#sketchCanvas");
          const base64 = canvas.toDataURL("image/png").split(",")[1];
          const res = await fetch(`${API}/api/assist/vision`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ image: base64 }),
          });
          if (!res.ok) throw new Error(`${res.status}`);
          const data = await res.json();
          const chips = [data.suggested_prompt];
          if (data.composition_tips) chips.push(...data.composition_tips.slice(0, 2));
          setSuggestionChips(chips.filter(Boolean));
        } catch (e) {
          showToast("Suggest failed: " + e.message, "error");
        } finally {
          btn.disabled = false;
          btn.classList.remove("loading");
          btn.textContent = "Suggest";
        }
      }

      async function onEnhanceClick() {
        const btn = $("#enhanceBtn");
        if (!btn || btn.disabled) return;
        const prompt = $("#promptInput")?.value?.trim();
        if (!prompt) {
          showToast("Enter a prompt first", "warn");
          return;
        }
        btn.disabled = true;
        btn.classList.add("loading");
        btn.textContent = "Enhancing\u2026";
        try {
          const res = await fetch(`${API}/api/assist/prompt`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt }),
          });
          if (!res.ok) throw new Error(`${res.status}`);
          const data = await res.json();
          const chips = [data.enhanced, ...(data.alternatives || [])];
          setSuggestionChips(chips.filter(Boolean));
        } catch (e) {
          showToast("Enhance failed: " + e.message, "error");
        } finally {
          btn.disabled = false;
          btn.classList.remove("loading");
          btn.textContent = "Enhance";
        }
      }

      // ========================================================================
      // Debounced live submit
      // ========================================================================
      function scheduleSubmit() {
        if (debounceTimer) clearTimeout(debounceTimer);
        abortVarietyBatch();
        updateSketchTips();
        debounceTimer = setTimeout(() => {
          if (hasStrokes) {
            submitCanvasToQueue();
          }
        }, 300);
      }

      // ========================================================================
      // Random prompt words
      // ========================================================================
      let wordList = [];

      async function loadWordList() {
        try {
          const res = await fetch(`${API}/static/words.txt`);
          const text = await res.text();
          wordList = text.split("\n").filter((w) => w.trim());
        } catch (e) {
          console.error("Failed to load word list:", e);
        }
      }

      function randomPrompt(count = 3) {
        return fmtRandomPrompt(wordList, count);
      }

      function initPrompt() {
        const prompt = $("#promptInput");
        if (!prompt.value.trim()) {
          prompt.value = "a pencil sketch of a llama cartoon abstract logo";
        }
      }

      // ========================================================================
      // IndexedDB storage layer
      // ========================================================================
      let db = null;
      let currentSessionId = null;

      function initDB() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open("pencilflux", 1);
          req.onupgradeneeded = (e) => {
            const d = e.target.result;
            if (!d.objectStoreNames.contains("images")) {
              const store = d.createObjectStore("images", { autoIncrement: true });
              store.createIndex("sessionId", "sessionId", { unique: false });
            }
            if (!d.objectStoreNames.contains("sessions")) {
              d.createObjectStore("sessions", { keyPath: "id" });
            }
          };
          req.onsuccess = (e) => {
            db = e.target.result;
            resolve(db);
          };
          req.onerror = (e) => {
            console.error("IndexedDB error:", e);
            resolve(null);
          };
        });
      }

      function dbSaveImage(blob) {
        if (!db || !currentSessionId) return Promise.resolve();
        return new Promise((resolve) => {
          const tx = db.transaction(["images", "sessions"], "readwrite");
          tx.objectStore("images").add({
            sessionId: currentSessionId,
            blob,
            timestamp: Date.now(),
          });
          // Bump image count on session
          const sessStore = tx.objectStore("sessions");
          const getReq = sessStore.get(currentSessionId);
          getReq.onsuccess = () => {
            const sess = getReq.result;
            if (sess) {
              sess.imageCount = (sess.imageCount || 0) + 1;
              sessStore.put(sess);
            }
          };
          tx.oncomplete = () => resolve();
          tx.onerror = () => resolve();
        });
      }

      function dbGetSessionImages(sessionId) {
        if (!db) return Promise.resolve([]);
        return new Promise((resolve) => {
          const tx = db.transaction("images", "readonly");
          const idx = tx.objectStore("images").index("sessionId");
          const req = idx.getAll(sessionId);
          req.onsuccess = () => resolve(req.result.map((r) => r.blob));
          req.onerror = () => resolve([]);
        });
      }

      function dbGetSessions() {
        if (!db) return Promise.resolve([]);
        return new Promise((resolve) => {
          const tx = db.transaction("sessions", "readonly");
          const req = tx.objectStore("sessions").getAll();
          req.onsuccess = () => {
            const sessions = req.result.sort((a, b) => b.createdAt - a.createdAt);
            resolve(sessions);
          };
          req.onerror = () => resolve([]);
        });
      }

      function dbDeleteSession(sessionId) {
        if (!db) return Promise.resolve();
        return new Promise((resolve) => {
          const tx = db.transaction(["images", "sessions"], "readwrite");
          // Delete all images for this session
          const idx = tx.objectStore("images").index("sessionId");
          const curReq = idx.openCursor(sessionId);
          curReq.onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
              cursor.delete();
              cursor.continue();
            }
          };
          // Delete session record
          tx.objectStore("sessions").delete(sessionId);
          tx.oncomplete = () => resolve();
          tx.onerror = () => resolve();
        });
      }

      function dbCreateSession(id) {
        if (!db) return Promise.resolve();
        const now = new Date(id);
        const label =
          now.toLocaleDateString("en-US", { month: "short", day: "numeric" }) +
          ", " +
          now.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit" });
        return new Promise((resolve) => {
          const tx = db.transaction("sessions", "readwrite");
          tx.objectStore("sessions").put({ id, label, createdAt: id, imageCount: 0 });
          tx.oncomplete = () => resolve();
          tx.onerror = () => resolve();
        });
      }

      // ========================================================================
      // Sessions modal
      // ========================================================================
      $("#sessionsBtn").addEventListener("click", openSessionsModal);

      async function openSessionsModal() {
        const sessions = await dbGetSessions();

        const overlay = document.createElement("div");
        overlay.className = "sessions-modal";

        const dialog = document.createElement("div");
        dialog.className = "sessions-dialog";

        const header = document.createElement("h2");
        header.innerHTML = 'Sessions <button class="sessions-close">&times;</button>';
        dialog.appendChild(header);

        header.querySelector(".sessions-close").addEventListener("click", () => overlay.remove());

        if (sessions.length === 0) {
          const empty = document.createElement("p");
          empty.style.cssText = "color:var(--text-muted);font-size:0.85rem";
          empty.textContent = "No sessions yet. Generate some images!";
          dialog.appendChild(empty);
        }

        for (const sess of sessions) {
          const isCurrent = sess.id === currentSessionId;
          const row = document.createElement("div");
          row.className = "session-row";

          const hdr = document.createElement("div");
          hdr.className = "session-header";
          const arrow = document.createElement("span");
          arrow.className = "session-arrow" + (isCurrent ? " open" : "");
          arrow.textContent = "\u25B6";
          const info = document.createElement("span");
          info.textContent =
            (isCurrent ? "Current \u2014 " : "") + sess.label + ` (${sess.imageCount || 0})`;
          const leftSide = document.createElement("span");
          leftSide.appendChild(arrow);
          leftSide.appendChild(document.createTextNode(" "));
          leftSide.appendChild(info);
          hdr.appendChild(leftSide);
          row.appendChild(hdr);

          const body = document.createElement("div");
          body.className = "session-body" + (isCurrent ? " open" : "");
          row.appendChild(body);

          // Toggle expand/collapse
          hdr.addEventListener("click", async () => {
            const isOpen = body.classList.contains("open");
            if (isOpen) {
              body.classList.remove("open");
              arrow.classList.remove("open");
            } else {
              body.classList.add("open");
              arrow.classList.add("open");
              // Load thumbnails if not already loaded
              if (!body.dataset.loaded) {
                body.dataset.loaded = "1";
                await loadSessionThumbs(body, sess.id);
              }
            }
          });

          // Auto-load current session thumbnails
          if (isCurrent) {
            loadSessionThumbs(body, sess.id);
          }

          dialog.appendChild(row);
        }

        overlay.appendChild(dialog);
        document.body.appendChild(overlay);

        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) overlay.remove();
        });
        const onKey = (e) => {
          if (e.key === "Escape") {
            overlay.remove();
            document.removeEventListener("keydown", onKey);
          }
        };
        document.addEventListener("keydown", onKey);
      }

      async function loadSessionThumbs(body, sessionId) {
        const blobs = await dbGetSessionImages(sessionId);
        body.innerHTML = "";

        const thumbsDiv = document.createElement("div");
        thumbsDiv.className = "session-thumbs";

        if (blobs.length === 0) {
          const empty = document.createElement("span");
          empty.style.cssText = "color:var(--text-muted);font-size:0.8rem";
          empty.textContent = "No images in this session";
          thumbsDiv.appendChild(empty);
        } else {
          for (const blob of blobs) {
            const url = URL.createObjectURL(blob);
            const img = document.createElement("img");
            img.src = url;
            img.addEventListener("click", () => openLightbox(url));
            img.addEventListener("contextmenu", (e) => showImageContextMenu(e, url));
            addLongPressHandler(img, () => confirmUseAsSketch(url));
            thumbsDiv.appendChild(img);
          }
        }
        body.appendChild(thumbsDiv);

        const actions = document.createElement("div");
        actions.className = "session-actions";

        if (blobs.length > 0) {
          const dlBtn = document.createElement("button");
          dlBtn.className = "dl-zip";
          dlBtn.textContent = "Download ZIP";
          dlBtn.addEventListener("click", async () => {
            const sess = (await dbGetSessions()).find((s) => s.id === sessionId);
            dlBtn.textContent = "Zipping...";
            dlBtn.disabled = true;
            await downloadSessionZip(sessionId, sess ? sess.label : "session");
            dlBtn.textContent = "Download ZIP";
            dlBtn.disabled = false;
          });
          actions.appendChild(dlBtn);
        }

        if (sessionId !== currentSessionId) {
          const delBtn = document.createElement("button");
          delBtn.className = "del-session";
          delBtn.textContent = "Delete";
          delBtn.addEventListener("click", async () => {
            if (!confirm("Delete this session and all its images?")) return;
            await dbDeleteSession(sessionId);
            body.parentElement.remove();
          });
          actions.appendChild(delBtn);
        }

        body.appendChild(actions);
      }

      // ========================================================================
      // ZIP download
      // ========================================================================
      async function downloadSessionZip(sessionId, label) {
        const images = await dbGetSessionImages(sessionId);
        const zip = new JSZip();
        images.forEach((blob, i) => {
          const ext = blob.type === "image/jpeg" ? "jpg" : "png";
          zip.file(`image-${String(i + 1).padStart(3, "0")}.${ext}`, blob);
        });
        const content = await zip.generateAsync({ type: "blob" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(content);
        a.download = `pencilflux-${label.replace(/[^a-z0-9]/gi, "-")}.zip`;
        a.click();
        URL.revokeObjectURL(a.href);
      }

      // ========================================================================
      // Canvas drag-drop
      // ========================================================================
      const canvasWrap = $("#canvasWrap");

      canvasWrap.addEventListener("dragover", (e) => {
        e.preventDefault();
        canvasWrap.classList.add("drop-active");
      });

      canvasWrap.addEventListener("dragleave", () => {
        canvasWrap.classList.remove("drop-active");
      });

      canvasWrap.addEventListener("drop", (e) => {
        e.preventDefault();
        canvasWrap.classList.remove("drop-active");
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith("image/")) {
          handleFileToCanvas(file);
        }
      });

      // ========================================================================
      // Import action buttons (Mode A)
      // ========================================================================
      $("#presetDropdownBtn").addEventListener("click", (e) => {
        e.stopPropagation();
        const popover = $("#presetPopover");
        if (popover.classList.contains("open")) {
          popover.classList.remove("open");
        } else {
          const rect = e.target.getBoundingClientRect();
          popover.style.left = rect.left + "px";
          popover.style.top = rect.bottom + 4 + "px";
          popover.classList.add("open");
        }
      });

      document.addEventListener("click", (e) => {
        if (!e.target.closest(".preset-popover") && !e.target.closest("#presetDropdownBtn")) {
          $("#presetPopover").classList.remove("open");
        }
      });

      $("#uploadActionBtn").addEventListener("click", () => {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.addEventListener("change", (e) => handleFileToCanvas(e.target.files[0]));
        input.click();
      });

      $("#pasteActionBtn").addEventListener("click", async () => {
        try {
          const items = await navigator.clipboard.read();
          for (const item of items) {
            const imageType = item.types.find((t) => t.startsWith("image/"));
            if (imageType) {
              const blob = await item.getType(imageType);
              const url = URL.createObjectURL(blob);
              const img = new Image();
              img.onload = () => {
                pushUndoState();
                drawImageToCanvas(img);
                hasStrokes = true;
                updateOverlayImage();
                updateCanvasImgInfo();
                scheduleSubmit();
                URL.revokeObjectURL(url);
              };
              img.src = url;
              return;
            }
          }
        } catch (e) {
          console.error("Paste failed:", e);
          showToast("Paste failed — no image in clipboard?", "warn");
        }
      });

      // ========================================================================
      // Drawer (Mode C)
      // ========================================================================
      $("#drawerBtn").addEventListener("click", () => {
        $("#canvasDrawer").classList.toggle("open");
      });

      $("#drawerFileInput").addEventListener("change", (e) => {
        handleFileToCanvas(e.target.files[0]);
        $("#canvasDrawer").classList.remove("open");
        e.target.value = "";
      });

      // ========================================================================
      // Assist buttons
      // ========================================================================
      $("#suggestBtn").addEventListener("click", onSuggestClick);
      $("#enhanceBtn").addEventListener("click", onEnhanceClick);

      // ========================================================================
      // Init
      // ========================================================================
      checkHealth();
      setInterval(checkHealth, 30000);
      pollGpuStats();
      setInterval(pollGpuStats, 1000);
      pollUsage();
      setInterval(pollUsage, 30000);
      loadSketches();
      checkAssistConfig();
      setInterval(checkAssistConfig, 30000);
      initOnboarding();
      loadWordList().then(initPrompt);
      // Load saved creativity range
      const savedRange = localStorage.getItem("creativityRange");
      if (savedRange) {
        try {
          creativityRange = JSON.parse(savedRange);
        } catch {
          /* ignore corrupted data */
        }
      }
      updateCreativityRangeUI();
      // Apply saved layout mode
      applyLayout(localStorage.getItem("layoutMode") || "D");

      // Init IndexedDB and session
      initDB().then(async () => {
        if (!db) return;
        const sessions = await dbGetSessions();
        const recent = sessions[0];
        const ONE_HOUR = 60 * 60 * 1000;
        if (recent && Date.now() - recent.createdAt < ONE_HOUR) {
          currentSessionId = recent.id;
          // Repopulate history strip from stored blobs
          const blobs = await dbGetSessionImages(currentSessionId);
          for (const blob of blobs) {
            const url = URL.createObjectURL(blob);
            addToHistoryDOM(url);
          }
        } else {
          currentSessionId = Date.now();
          await dbCreateSession(currentSessionId);
        }
      });
    </script>
    <footer
      style="
        text-align: center;
        padding: 12px 24px;
        font-size: 0.75rem;
        color: var(--text-muted);
        border-top: 1px solid var(--border);
      "
    >
      LlamaSketch &mdash; an app by LlamaTree &middot; All rights reserved &middot;
      <script>
        document.write(new Date().getFullYear());
      </script>
      <span id="appCommitHash"></span>
    </footer>
    <script>
      fetch("/api/config")
        .then(function (r) {
          return r.json();
        })
        .then(function (d) {
          var el = document.getElementById("appCommitHash");
          if (el && d.git_commit && d.git_commit !== "dev") el.textContent = "· " + d.git_commit;
        })
        .catch(function () {});
    </script>
  </body>
</html>
